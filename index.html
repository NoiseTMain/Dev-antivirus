<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Nexus Prime Security - V9.0 (Kompletn√≠)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- CSS STYLING --- */
        :root {
            /* P≈Øvodn√≠ Dark Mode */
            --color-dark-bg: #1e1e2c; 
            --color-darker-bg: #151520; 
            --color-text-light: #f0f0f5;
            --color-text-grey: #a0a0b0;
            --color-border: #303040;
            
            /* Spoleƒçn√© barvy */
            --color-accent-blue: #007bff; 
            --color-accent-green: #28a745; 
            --color-danger-red: #dc3545;
            --color-warning-yellow: #ffc107;
            
            /* Nov√© - Svƒõtl√Ω re≈æim */
            --color-light-bg: #f5f5f5;
            --color-lighter-bg: #ffffff;
            --color-light-text-dark: #333333;
            --color-light-text-grey: #555555;
            --color-light-border: #cccccc;

            /* Dynamick√© promƒõnn√© pro t√©ma (defaultnƒõ DARK) */
            --app-bg: var(--color-darker-bg);
            --module-bg: var(--color-dark-bg);
            --content-bg: #2a2a3b;
            --text-color: var(--color-text-light);
            --text-muted: var(--color-text-grey);
            --input-bg: var(--color-darker-bg);
            --input-border: var(--color-border);
            --nav-active: var(--color-accent-blue);
            --nav-inactive: var(--color-text-grey);
            --hr-color: var(--color-border);
        }
        
        /* T√©ma LIGHT MODE */
        .light-mode {
            --app-bg: var(--color-lighter-bg);
            --module-bg: var(--color-light-bg);
            --content-bg: var(--color-lighter-bg);
            --text-color: var(--color-light-text-dark);
            --text-muted: var(--color-light-text-grey);
            --input-bg: var(--color-lighter-bg);
            --input-border: var(--color-light-border);
            --nav-active: var(--color-accent-blue);
            --nav-inactive: var(--color-light-text-grey);
            --hr-color: var(--color-light-border);
        }


        body {
            background-color: var(--app-bg); 
            color: var(--text-color);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        #app-window {
            width: 400px; 
            height: 700px; 
            background-color: var(--module-bg);
            border-radius: 25px; 
            box-shadow: 0 20px 50px rgba(0 0 0 / 50%), 0 0 0 10px #000; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s;
        }

        /* HLAVIƒåKA */
        #header {
            background-color: var(--app-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--hr-color);
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .logo {
            color: var(--text-color);
            font-size: 1.4em;
            font-weight: 700;
        }
        #profile-btn, #notifications-btn, #theme-toggle-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        #profile-btn:hover, #notifications-btn:hover, #theme-toggle-btn:hover { color: var(--color-accent-blue); }
        
        #user-info-status {
             font-size: 0.8em;
             line-height: 1.3;
             text-align: right;
        }
        .status-inactive { color: var(--color-danger-red); } 
        .status-active { color: var(--color-accent-green); font-weight: bold; } 
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .notification-indicator {
            position: relative;
        }
        .notification-indicator::after {
            content: attr(data-count);
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--color-danger-red);
            color: white;
            border-radius: 50%;
            padding: 1px 5px;
            font-size: 0.7em;
            font-weight: bold;
            display: none; /* Skryto defaultnƒõ */
        }
        .notification-indicator.active::after {
             display: inline-block;
        }

        /* OBSAHOV√Å OBLAST */
        #content-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; 
            padding-bottom: 80px; 
        }
        .module { animation: fadeIn 0.5s; }
        .module.hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 { color: var(--text-color); border-bottom: 1px solid var(--hr-color); padding-bottom: 10px; margin-bottom: 20px; font-weight: 500; font-size: 1.4em;}
        
        .primary-btn, .secondary-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%; 
            box-sizing: border-box;
            margin-bottom: 10px;
            transition: background-color 0.2s, color 0.2s;
        }
        .primary-btn {
            background-color: var(--color-accent-blue);
            color: white;
            font-size: 1.1em;
            margin-top: 15px;
        }
        .secondary-btn {
            background-color: var(--input-border);
            color: var(--text-color);
            margin-top: 15px;
        }
        .primary-btn:disabled, .secondary-btn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
        }
        
        /* Formul√°≈ôe */
        .auth-form-container {
             background-color: var(--content-bg);
             padding: 30px 20px;
             border-radius: 12px;
             margin-top: 30px;
             transition: background-color 0.3s;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            margin-bottom: 15px;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            margin-bottom: 15px;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        
        /* NAVIGACE */
        #bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: var(--app-bg);
            border-top: 1px solid var(--hr-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px 0;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--nav-inactive);
            font-size: 0.75em;
            flex: 1;
            cursor: pointer;
            transition: color 0.3s;
        }
        .nav-item.active { color: var(--nav-active); }
        .nav-item.locked { opacity: 0.6; color: var(--color-danger-red); cursor: not-allowed; }
        .nav-item i { font-size: 1.5em; margin-bottom: 3px; }

        /* --- STYLY PRO KONFIGURACE (Identity, Scan) --- */
        .config-group {
             background-color: var(--content-bg);
             padding: 15px;
             border-radius: 10px;
             margin-bottom: 20px;
             transition: background-color 0.3s;
        }
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--hr-color);
        }
        .config-item:last-child { border-bottom: none; }
        .item-info strong { display: block; }
        .item-info span { font-size: 0.8em; color: var(--text-muted); }
        .config-item:hover { background-color: rgba(128, 128, 128, 0.1); border-radius: 5px; padding: 10px; margin: -5px 0;}

        /* Toggle/Checkbox styly */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 25px;
        }
        .toggle-switch input { display: none; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--input-border); transition: 0.4s; border-radius: 25px;
        }
        .slider:before {
            position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
            background-color: var(--text-color); transition: 0.4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--color-accent-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        /* Historie */
        .activity-log-item {
            background-color: var(--input-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .activity-log-item strong { color: var(--color-accent-blue); }
        
        /* Dashboard Cards */
        .dashboard-card {
            background-color: var(--content-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: background-color 0.3s;
        }
        .stat-widget {
             display: flex;
             justify-content: space-between;
             padding: 5px 0;
             font-size: 0.9em;
             color: var(--text-muted);
        }
        
        /* VPN */
        #vpn-status-header {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        #vpn-ip-display {
             color: var(--color-warning-yellow);
        }

    </style>
</head>
<body>

    <div id="app-window" class="dark-mode">
        <header id="header">
             <h1 class="logo">Nexus Prime Security</h1>
             <div class="header-controls">
                 <button id="notifications-btn" class="notification-indicator" data-count="0" onclick="switchModule('notifications')">
                    <i class="fas fa-bell"></i>
                 </button>
                 <button id="theme-toggle-btn" onclick="handleThemeSwitch()">
                    <i class="fas fa-moon"></i>
                 </button>
                 <div id="user-info-status">
                     <span id="header-username">Odhl√°≈°eno</span><br>
                     <span id="header-license-status" class="status-inactive">Neaktivn√≠</span>
                 </div>
                 <button id="profile-btn" onclick="switchModule('settings')">
                    <i class="fas fa-user-circle"></i>
                 </button>
             </div>
        </header>

        <main id="content-area">
            
            <div id="auth_select" class="module hidden">
                <h2>V√≠tejte v Nexus Prime</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Zabezpeƒçte sv√© mobiln√≠ za≈ô√≠zen√≠. Pro p≈ô√≠stup k ochranƒõ se p≈ôihlaste nebo vytvo≈ôte nov√Ω √∫ƒçet.</p>
                <div class="auth-form-container">
                    <button id="show-login-btn" class="primary-btn">P≈ôihl√°sit se k √∫ƒçtu</button>
                    <button id="show-register-btn" class="secondary-btn">Vytvo≈ôit √öƒçet</button>
                </div>
            </div>

            <div id="login" class="module hidden">
                <h2><i class="fas fa-sign-in-alt"></i> P≈ôihl√°≈°en√≠ k √∫ƒçtu</h2>
                <div class="auth-form-container">
                    <p id="login-message" style="margin-bottom: 20px; color: var(--text-muted);">Zadejte sv√© u≈æivatelsk√© jm√©no a heslo:</p>
                    <div id="login-form">
                        <input type="text" id="login-username" placeholder="U≈æivatelsk√© jm√©no">
                        <input type="password" id="login-password" placeholder="Heslo">
                        <button id="login-btn" class="primary-btn">P≈ôihl√°sit se</button>
                        <button class="secondary-btn" onclick="switchModule('auth_select')">Zpƒõt</button>
                    </div>
                </div>
            </div>
            
            <div id="register" class="module hidden">
                 <h2><i class="fas fa-user-plus"></i> Vytvo≈ôen√≠ Nov√©ho √öƒçtu</h2>
                 <div class="auth-form-container">
                     <p style="margin-bottom: 20px;">Z√≠skejte p≈ô√≠stup k funkc√≠m Freemium verze.</p>
                     <div id="register-form">
                         <input type="text" id="reg-username" placeholder="U≈æivatelsk√© jm√©no">
                         <input type="password" id="reg-password" placeholder="Heslo">
                         <button id="register-btn" class="primary-btn">Vytvo≈ôit √öƒçet a P≈ôihl√°sit se</button>
                         <button class="secondary-btn" onclick="switchModule('auth_select')">Zpƒõt</button>
                     </div>
                 </div>
            </div>
            
            <div id="dashboard" class="module hidden">
                </div>
            
            <div id="paysafe" class="module hidden">
                <h2><i class="fas fa-credit-card"></i> Aktivace PRO Verze</h2>
                <div id="paysafe-payment-box" class="config-group">
                    </div>
            </div>
            
            <div id="scan" class="module hidden">
                <h2><i class="fas fa-rocket"></i> Chytr√Ω Sken</h2>
                <div id="scan-content" class="premium-feature"></div>
            </div>
            
            <div id="vpn" class="module hidden">
                <h2><i class="fas fa-globe"></i> VPN Prime</h2>
                <div id="vpn-content" class="premium-feature"></div>
            </div>
            
            <div id="identity" class="module hidden">
                 <h2><i class="fas fa-user-shield"></i> Identity Guard</h2>
                <div id="identity-content" class="premium-feature">
                     </div>
            </div>
            
            <div id="settings" class="module hidden">
                <h2><i class="fas fa-cogs"></i> Profil a Historie</h2>
                <div id="settings-content" class="premium-feature">
                    </div>
            </div>
            
            <div id="notifications" class="module hidden">
                 <h2><i class="fas fa-bell"></i> Centrum Upozornƒõn√≠</h2>
                 <div id="notifications-list" class="config-group">
                     </div>
                 <button class="secondary-btn" id="clear-notifications-btn" onclick="clearNotifications()" disabled>Vymazat v≈°echna upozornƒõn√≠</button>
            </div>
            
            <div id="optimization" class="module hidden">
                 <h2><i class="fas fa-tachometer-alt"></i> Optimalizace V√Ωkonu</h2>
                 <div id="optimization-content" class="premium-feature"></div>
            </div>
            
            <div id="web_shield" class="module hidden">
                 <h2><i class="fas fa-shield-alt"></i> Web Shield & Anti-Phishing</h2>
                 <div id="web-shield-content" class="premium-feature"></div>
            </div>
            
            <div id="vault" class="module hidden">
                 <h2><i class="fas fa-lock"></i> Zabezpeƒçen√Ω Trezor</h2>
                 <div id="vault-content" class="premium-feature"></div>
            </div>
            
            <div id="backup" class="module hidden">
                 <h2><i class="fas fa-cloud-upload-alt"></i> Cloudov√© Z√°lohov√°n√≠</h2>
                 <div id="backup-content" class="premium-feature"></div>
            </div>
            
             <div id="privacy" class="module hidden">
                 <h2><i class="fas fa-user-secret"></i> Ochrana Soukrom√≠</h2>
                 <div id="privacy-content" class="premium-feature"></div>
            </div>


        </main>
        
        <nav id="bottom-nav">
            <a href="#" class="nav-item active" data-module="dashboard" id="dashboard-nav">
                <i class="fas fa-home"></i> Home
            </a>
            <a href="#" class="nav-item locked" data-module="scan" id="scan-nav">
                <i class="fas fa-rocket"></i> Sken
            </a>
            <a href="#" class="nav-item locked" data-module="vpn" id="vpn-nav">
                <i class="fas fa-globe"></i> VPN
            </a>
            <a href="#" class="nav-item locked" data-module="identity" id="identity-nav">
                <i class="fas fa-user-shield"></i> Identity
            </a>
            <a href="#" class="nav-item locked" data-module="optimization" id="optimization-nav">
                <i class="fas fa-tachometer-alt"></i> Optimalizace
            </a>
            <a href="#" class="nav-item locked" data-module="web_shield" id="web_shield-nav">
                <i class="fas fa-shield-alt"></i> Web
            </a>
             <a href="#" class="nav-item locked" data-module="settings" id="settings-nav">
                <i class="fas fa-cogs"></i> Profil
            </a>
        </nav>
    </div>

    <script>
        /* --- JAVASCRIPT LOGIKA --- */
        const CURRENT_USER_KEY = 'nexusPrimeCurrentUser';
        const REGISTERED_USERS_KEY = 'nexusPrimeRegisteredUsers';
        const ACTIVITY_LOG_KEY = 'nexusPrimeActivityLog';
        const NOTIFICATIONS_KEY = 'nexusPrimeNotifications';
        const PRO_PRICE = 7999;
        const SIMULATED_PIN_VALUES = [3610, 3610, 779]; 

        let currentUser = null;
        
        // --- DATA A JAZYKOV√â PROMƒöNN√â (Idea 25, 30) ---
        
        const i18n = {
            "cs": {
                "welcome": "V√≠tejte zpƒõt,", "paid_active": "PRO aktivn√≠", "freemium_active": "Freemium", 
                "lock_title": "Tato funkce je uzamƒçena!", "lock_msg": "K odemƒçen√≠ je nutn√° **PRO licence**.",
                "status_active": "Aktivn√≠ PRO verze", "status_free": "Freemium (Z√°kladn√≠ ochrana)",
                "buy_pro": "Koupit PRO licenci", "logout": "Odhl√°sit se", "scan_run": "Spustit Sken",
                "scan_repair": "Opravit V≈°e (1 kliknut√≠)", "threats_found": "Nalezen√© hrozby:",
                "scan_status_ready": "P≈ôipraveno ke spu≈°tƒõn√≠.", "scan_status_running": "Skenov√°n√≠ prob√≠h√°...",
                "repair_done": "Oprava dokonƒçena!", "scan_done": "Skenov√°n√≠ dokonƒçeno! Nalezeno %s hrozeb.",
                "app_perm_scan": "Kontrola opr√°vnƒõn√≠ aplikac√≠", "app_perm_info": "Tyto aplikace maj√≠ opr√°vnƒõn√≠ k p≈ô√≠stupu k citliv√Ωm dat≈Øm. Mƒõli byste je zkontrolovat.",
                "app_perm_title": "Opr√°vnƒõn√≠ aplikace", "app_perm_toggle": "Omezit p≈ô√≠stup",
                "app_perm_toggle_on": "Povolit", "app_perm_toggle_off": "Omezit",
                "vault_title": "Simulovan√Ω Trezor", "vault_desc": "Bezpeƒçnƒõ ulo≈æte p≈ôihla≈°ovac√≠ √∫daje a dokumenty."
            },
            "en": {
                "welcome": "Welcome back,", "paid_active": "PRO Active", "freemium_active": "Freemium",
                "lock_title": "This feature is locked!", "lock_msg": "PRO license is required to unlock.",
                "status_active": "Active PRO Version", "status_free": "Freemium (Basic Protection)",
                "buy_pro": "Buy PRO License", "logout": "Log Out", "scan_run": "Run Scan",
                "scan_repair": "Repair All (1 Click)", "threats_found": "Threats Found:",
                "scan_status_ready": "Ready to run.", "scan_status_running": "Scanning in progress...",
                "repair_done": "Repair completed!", "scan_done": "Scanning complete! %s threats found.",
                "app_perm_scan": "Application Permissions Check", "app_perm_info": "These apps have access to sensitive data. You should review them.",
                "app_perm_title": "App Permission", "app_perm_toggle": "Limit Access",
                "app_perm_toggle_on": "Allow", "app_perm_toggle_off": "Limit",
                "vault_title": "Simulated Vault", "vault_desc": "Securely store your login credentials and documents."
            }
        };

        const SIMULATION_DATA = {
            // Idea 1/23 - Podrobn√© hrozby
            SIMULATED_THREATS: [
                 { name: "Cookie_ID: 45A-87Z", type: "Tracking", location: "/data/user/cache/chrome" },
                 { name: "Nezabezpeƒçen√Ω WiFi Port (8080)", type: "Network Vulnerability", location: "Router Settings" },
                 { name: "Zastaral√Ω syst√©mov√Ω patch (Kernel)", type: "System Vulnerability", location: "System Core" },
                 { name: "FakeSystemUpdater.apk", type: "Malware/PUP", location: "/storage/downloads" },
                 { name: "Naru≈°en√≠: Primary email", type: "Identity Breach", location: "Dark Web Report" }
            ],
            // Idea 11/26 - Opr√°vnƒõn√≠ aplikac√≠
            APP_PERMISSIONS: [
                 { name: "Facebook", type: "Social", permissions: ["Poloha", "Mikrofon", "Kontakty"] },
                 { name: "Bankovn√≠ App", type: "Finance", permissions: ["S√≠≈•", "Stav telefonu"] },
                 { name: "Hra XYZ", type: "Game", permissions: ["Kontakty", "Galerie"] },
                 { name: "Kamera", type: "System", permissions: ["Poloha", "Mikrofon", "Galerie"] },
                 { name: "Simulovan√° ≈†pehovac√≠ App", type: "Malware", permissions: ["Poloha", "Mikrofon", "S√≠≈•", "Galerie"] }
            ],
            // Idea 6 - VPN Protokoly
            VPN_PROTOCOLS: ["WireGuard (Doporuƒçeno)", "OpenVPN", "IKEv2"],
            // Idea 13 - Technick√© detaily
            SYSTEM_INFO: {
                KERNEL_VERSION: "5.15.0-94-generic",
                PATCH_DATE: new Date('2025-11-01'), // Simulace star√©ho patche
                LAST_IP: "192.168.1.100",
                QUARANTINE_CODE: "E3C4-F9D2-A1B7"
            },
            // Idea 8 - HW widgety
            HW_STATS: {
                 RAM: { total: 8000, used: 5200 },
                 BATTERY: { health: 98, temp: 35.5 }
            },
            
            IDENTITY_ITEMS: [
                { name: "Prim√°rn√≠ e-mail", type: "email", defaultChecked: true },
                { name: "Z√°lo≈æn√≠ e-mail", type: "email", defaultChecked: false },
                { name: "ƒå√≠slo kreditn√≠ karty (4 cifry)", type: "card", defaultChecked: true },
                { name: "Rodn√© ƒç√≠slo", type: "social", defaultChecked: true },
                { name: "Telefonn√≠ ƒç√≠slo", type: "phone", defaultChecked: true },
                { name: "U≈æivatelsk√© jm√©no (soci√°ln√≠ s√≠tƒõ)", type: "username", defaultChecked: true },
            ],
            SCAN_AREAS: [
                { name: "Syst√©mov√© soubory (j√°dro OS)", default: true },
                { name: "Aplikace t≈ôet√≠ch stran", default: true },
                { name: "Registry a datab√°ze", default: true },
            ],
            VPN_SERVERS: [
                "Automaticky (Nejrychlej≈°√≠)", "ƒåesk√° republika (Praha 1)", "Nƒõmecko (Frankfurt)", 
                "USA (New York)", "Japonsko (Tokio)", "Singapur"
            ],
            // Idea 22 - Simulace Phishingu
            PHISHING_URLS: {
                "google.com": false,
                "banka.cz": false,
                "phishing.com": true,
                "securelogin.net": true
            }
        };

        let currentLang = 'cs';
        const _ = (key) => i18n[currentLang][key] || key;
        
        // --- NOV√â GLOB√ÅLN√ç STAVY ---
        let vpnInterval = null;
        let isVpnConnected = false;
        let simulatedThreats = [];
        
        // --- FUNKCE PRO V√ùPOƒåET A TRVALOST DAT (Idea 5, 28) ---
        const calculateExpirationDate = () => {
            const today = new Date();
            today.setFullYear(today.getFullYear() + 1);
            return today.toLocaleDateString('cs-CZ', { year: 'numeric', month: 'numeric', day: 'numeric' });
        };
        
        const calculateSimulatedIP = (serverName) => {
             const parts = serverName.match(/\((.*?)\)/);
             let base = '104.28.';
             if (parts && parts[1].includes('Praha')) base = '85.15.';
             if (parts && parts[1].includes('New York')) base = '23.227.';
             
             // Generuje n√°hodn√© posledn√≠ dva bloky
             const randomPart = Math.floor(Math.random() * 255) + '.' + Math.floor(Math.random() * 255);
             return base + randomPart;
        };
        
        const getRegisteredUsers = () => { return JSON.parse(localStorage.getItem(REGISTERED_USERS_KEY)) || {}; };
        const saveRegisteredUsers = (users) => { localStorage.setItem(REGISTERED_USERS_KEY, JSON.stringify(users)); };
        const saveCurrentUserState = () => { if (currentUser) localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser)); };
        
        // NOV√Å: Kontrola Expirace a downgrade (Idea 5)
        const checkLicenseExpiration = (user) => {
            if (user.isPaid && user.license_expiration_date) {
                const expiry = new Date(user.license_expiration_date.split('.').reverse().join('-'));
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Pro p≈ôesn√© porovn√°n√≠ dat
                
                if (expiry < today) {
                    user.isPaid = false;
                    user.remainingAmount = PRO_PRICE;
                    user.license_expiration_date = null;
                    user.userLevel = Math.max(1, user.userLevel - 2); // Sn√≠≈æen√≠ levelu za neprodlou≈æen√≠
                    logActivity(`VAROV√ÅN√ç: PRO licence vypr≈°ela dne ${expiry.toLocaleDateString('cs-CZ')}. P≈ôepnuto na Freemium.`, 'var(--color-danger-red)');
                    alert('VAROV√ÅN√ç: Va≈°e PRO licence vypr≈°ela. Byly uzamƒçeny PRO funkce.');
                    return false; // Expirov√°no
                }
            }
            return user.isPaid; // Vr√°t√≠ aktu√°ln√≠ stav
        };

        const loadCurrentUserState = () => { 
             const stored = localStorage.getItem(CURRENT_USER_KEY);
             if (stored) {
                 let storedUser = JSON.parse(stored);
                 const users = getRegisteredUsers();
                 const fullUser = users[storedUser.username] || storedUser;
                 
                 currentUser = {
                     username: fullUser.username,
                     password: fullUser.password,
                     isPaid: fullUser.isPaid || false,
                     remainingAmount: fullUser.remainingAmount || PRO_PRICE,
                     pinIndex: fullUser.pinIndex || 0,
                     license_expiration_date: fullUser.license_expiration_date || null,
                     userLevel: fullUser.userLevel || 1, // NOV√â: U≈æivatelsk√° √∫rove≈à (Idea 28)
                     currentTheme: fullUser.currentTheme || 'dark', // NOV√â: T√©ma (Idea 30)
                     vpnIp: fullUser.vpnIp || SIMULATION_DATA.SYSTEM_INFO.LAST_IP, // NOV√â: IP (Idea 6)
                     hasBreach: fullUser.hasBreach || false, // NOV√â: Poru≈°en√≠ identity (Idea 2)
                     threatsFound: fullUser.threatsFound || 0, // NOV√â: Poƒçet hrozeb
                     
                 };
                 
                 // Kontrola expirace po naƒçten√≠
                 checkLicenseExpiration(currentUser);
                 saveCurrentUserState();
                 return true;
             }
             return false;
        };
        
        const switchModule = (moduleId) => {
            if (!currentUser && moduleId !== 'auth_select' && moduleId !== 'login' && moduleId !== 'register') {
                alert(_('Must_login')); // Zjednodu≈°eno
                moduleId = 'auth_select';
            }
            // Zamyk√°n√≠ PRO modul≈Ø p≈ôi Freemium
            const isPro = currentUser ? currentUser.isPaid : false;
            const proModules = ['scan', 'vpn', 'identity', 'optimization', 'web_shield', 'vault', 'privacy', 'backup', 'settings'];
            if (!isPro && proModules.includes(moduleId)) {
                 alert(`${_('lock_title')} ${_('lock_msg')}`);
                 return;
            }

            document.querySelectorAll('.module').forEach(m => m.classList.add('hidden'));
            document.getElementById(moduleId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[data-module="${moduleId}"]`) || document.getElementById('dashboard-nav');
            if (activeNav) activeNav.classList.add('active');
            
            // Speci√°ln√≠ funkce pro nov√© moduly (pro jejich dynamick√© naƒçten√≠)
            if (moduleId === 'paysafe') setPaysafeModuleContent();
            if (moduleId === 'optimization') document.getElementById('optimization-content').innerHTML = generateOptimizationHtml();
            if (moduleId === 'web_shield') document.getElementById('web-shield-content').innerHTML = generateWebShieldHtml();
            if (moduleId === 'vault') document.getElementById('vault-content').innerHTML = generateVaultHtml();
            if (moduleId === 'backup') document.getElementById('backup-content').innerHTML = generateBackupHtml();
            if (moduleId === 'privacy') document.getElementById('privacy-content').innerHTML = generatePrivacyHtml();
            if (moduleId === 'settings') document.getElementById('settings-content').innerHTML = generateSettingsHtml();
            if (moduleId === 'notifications') displayNotifications();
        };

        // --- REALISTICK√ù LOG AKTIVIT ---
        const logActivity = (description, color = 'var(--color-text-light)') => {
            if (!currentUser) return;
            const logEntry = {
                timestamp: new Date().toLocaleDateString('cs-CZ') + ' ' + new Date().toLocaleTimeString('cs-CZ'),
                description: description,
                color: color
            };
            
            let logs = JSON.parse(localStorage.getItem(ACTIVITY_LOG_KEY)) || [];
            logs.unshift(logEntry); 
            localStorage.setItem(ACTIVITY_LOG_KEY, JSON.stringify(logs.slice(0, 50)));
            
            // Pokud je to chyba/hrozba, p≈ôidat i do Notifikac√≠
            if (color === 'var(--color-danger-red)') {
                addNotification(description);
            }
        };

        // --- NOTIFIKACE (Idea 7) ---
        const getNotifications = () => { return JSON.parse(localStorage.getItem(NOTIFICATIONS_KEY)) || []; };
        const saveNotifications = (notes) => { localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(notes)); };
        
        const addNotification = (message) => {
             let notes = getNotifications();
             const newNote = {
                 message: message,
                 timestamp: new Date().toLocaleTimeString('cs-CZ'),
                 read: false
             };
             notes.unshift(newNote);
             saveNotifications(notes);
             updateNotificationUI();
        };
        
        const updateNotificationUI = () => {
             let notes = getNotifications();
             const unreadCount = notes.filter(n => !n.read).length;
             const indicator = document.getElementById('notifications-btn');
             indicator.setAttribute('data-count', unreadCount);
             
             if (unreadCount > 0) {
                 indicator.classList.add('active');
                 indicator.style.color = 'var(--color-danger-red)';
             } else {
                 indicator.classList.remove('active');
                 indicator.style.color = 'var(--text-color)';
             }
        };
        
        const displayNotifications = () => {
            let notes = getNotifications();
            const listElement = document.getElementById('notifications-list');
            const clearBtn = document.getElementById('clear-notifications-btn');
            
            if (notes.length === 0) {
                 listElement.innerHTML = `<p style="color: var(--text-muted);">≈Ω√°dn√° nov√° upozornƒõn√≠.</p>`;
                 clearBtn.disabled = true;
                 return;
            }
            
            listElement.innerHTML = notes.map(note => `
                <div class="activity-log-item" style="border: 1px solid ${note.read ? 'transparent' : 'var(--color-danger-red)'}; opacity: ${note.read ? 0.7 : 1};">
                    <p style="margin: 0;">${note.message}</p>
                    <span style="font-size: 0.7em; color: var(--text-muted);">${note.timestamp}</span>
                </div>
            `).join('');
            
            // Oznaƒçit jako p≈ôeƒçten√© p≈ôi zobrazen√≠
            notes = notes.map(n => ({ ...n, read: true }));
            saveNotifications(notes);
            updateNotificationUI();
            clearBtn.disabled = false;
        };

        const clearNotifications = () => {
             saveNotifications([]);
             displayNotifications();
             logActivity("Upozornƒõn√≠ vymaz√°na z Centra Notifikac√≠.");
        };

        // --- AUTENTIZACE ---
        const handleRegister = () => { 
             const regUsername = document.getElementById('reg-username').value.trim();
             const regPassword = document.getElementById('reg-password').value.trim();
             const users = getRegisteredUsers();

             if (regUsername.length < 3 || regPassword.length < 5) {
                 alert('Pros√≠m, zadejte platn√© u≈æivatelsk√© jm√©no (min 3 znaky) a heslo (min 5 znak≈Ø).');
                 return;
             }
             if (users[regUsername] || (regUsername === 'Va≈°ek')) {
                  alert(`U≈æivatelsk√© jm√©no "${regUsername}" je ji≈æ obsazeno.`);
                  return;
             }
             
             // NOV√â: UserLevel, Theme, VPN IP, Threats
             const newUser = { 
                 username: regUsername, 
                 password: regPassword, 
                 isPaid: false, 
                 remainingAmount: PRO_PRICE, 
                 pinIndex: 0, 
                 license_expiration_date: null,
                 userLevel: 1, 
                 currentTheme: 'dark',
                 vpnIp: SIMULATION_DATA.SYSTEM_INFO.LAST_IP,
                 threatsFound: 5 // Freemium zaƒç√≠n√° s hrozbami
             };
             users[regUsername] = newUser;
             saveRegisteredUsers(users);
             currentUser = newUser;
             saveCurrentUserState();
             logActivity(`Registrace nov√©ho √∫ƒçtu: ${regUsername}.`);
             unlockFeaturesUI('Freemium', `${_('welcome')} ${regUsername}! V√°≈° √∫ƒçet byl vytvo≈ôen.`, 'dashboard');
        };
        
        const handleLogin = () => { 
             const loginUsername = document.getElementById('login-username').value.trim();
             const loginPassword = document.getElementById('login-password').value.trim();
             const users = getRegisteredUsers();
             
             // Speci√°ln√≠ √∫ƒçet pro testov√°n√≠ PRO verze
             if (loginUsername === 'Va≈°ek' && loginPassword === 'vasek11') {
                  // Zkontroluje, zda Va≈°ek m√° expiraci, pokud ne, nastav√≠ ji na rok dop≈ôedu (simulace aktivace)
                  const existingVa≈°ek = users['Va≈°ek'];
                  let expirationDate = existingVa≈°ek ? existingVa≈°ek.license_expiration_date : null;
                  
                  // Pokud Va≈°ek nen√≠ v users nebo mu vypr≈°ela licence, nastav√≠me mu ji znovu
                  if (!expirationDate || new Date(expirationDate.split('.').reverse().join('-')) < new Date()) {
                       expirationDate = calculateExpirationDate();
                  }

                  currentUser = { 
                      username: 'Va≈°ek', 
                      password: 'vasek11', 
                      isPaid: true, 
                      remainingAmount: 0, 
                      pinIndex: SIMULATED_PIN_VALUES.length,
                      license_expiration_date: expirationDate,
                      userLevel: 10,
                      currentTheme: existingVa≈°ek ? existingVa≈°ek.currentTheme : 'dark',
                      vpnIp: SIMULATION_DATA.SYSTEM_INFO.LAST_IP,
                      threatsFound: 0
                  };
                  
                  users['Va≈°ek'] = currentUser;
                  saveRegisteredUsers(users);
                  saveCurrentUserState();
                  logActivity(`P≈ôihl√°≈°en√≠ u≈æivatele Va≈°ek (PRO licence - Testovac√≠).`);
                  unlockFeaturesUI('PRO', `${_('welcome')} ${currentUser.username}! PRO verze je automaticky aktivov√°na.`, 'dashboard');
                  return;
             }

             const storedUser = users[loginUsername];
             if (storedUser && storedUser.password === loginPassword) {
                  currentUser = storedUser;
                  
                  // Kontrola expirace p≈ôi p≈ôihl√°≈°en√≠
                  const wasPaid = currentUser.isPaid;
                  checkLicenseExpiration(currentUser);
                  
                  saveCurrentUserState();
                  const licenseType = currentUser.isPaid ? 'PRO' : 'Freemium';
                  const message = (wasPaid && !currentUser.isPaid) ? `Licence vypr≈°ela. ${_('welcome')} ${currentUser.username}!` : `${_('welcome')} ${currentUser.username}!`;
                  
                  logActivity(`√öspƒõ≈°n√© p≈ôihl√°≈°en√≠ u≈æivatele ${currentUser.username}.`);
                  unlockFeaturesUI(licenseType, message, 'dashboard');
                  return;
             }

             document.getElementById('login-message').innerText = 'Chyba: Neplatn√© u≈æivatelsk√© jm√©no nebo heslo.';
             document.getElementById('login-message').style.color = 'var(--color-danger-red)';
        };
        
        const handleLogout = () => { 
             logActivity(`Odhl√°≈°en√≠ u≈æivatele ${currentUser.username}.`);
             currentUser = null;
             isVpnConnected = false;
             if(vpnInterval) clearInterval(vpnInterval);
             localStorage.removeItem(CURRENT_USER_KEY);
             localStorage.removeItem(NOTIFICATIONS_KEY); // Smazat notifikace p≈ôi odhl√°≈°en√≠
             
             document.getElementById('header-username').innerText = 'Odhl√°≈°eno';
             document.getElementById('header-license-status').innerText = 'Neaktivn√≠';
             document.getElementById('header-license-status').className = 'status-inactive';
             document.getElementById('app-window').className = 'dark-mode'; // Reset t√©matu
             document.querySelectorAll('.nav-item').forEach(nav => {
                 nav.classList.add('locked'); nav.querySelector('i').innerHTML = 'üîí'; 
             });
             document.getElementById('dashboard').innerHTML = '';
             updateNotificationUI();
             switchModule('auth_select');
        };

        // --- PLATEBN√ç MODUL LOGIKA (P≈Øvodn√≠ + Expirace) ---
         const updateRemainingDisplay = () => {
             // ... P≈Øvodn√≠ logika
             const remainingAmountSpan = document.getElementById('remaining-amount');
             if (!remainingAmountSpan || !currentUser) return;
             
             remainingAmountSpan.innerText = currentUser.remainingAmount.toLocaleString('cs-CZ') + ' Kƒç';

             if (currentUser.remainingAmount <= 0) {
                 remainingAmountSpan.classList.remove('text-remaining');
                 remainingAmountSpan.classList.add('text-paid');
                 
                 // NOV√â: Kalkulace a ulo≈æen√≠ data expirace
                 const expirationDate = calculateExpirationDate();
                 currentUser.isPaid = true;
                 currentUser.license_expiration_date = expirationDate;
                 currentUser.threatsFound = 0;
                 currentUser.userLevel = Math.max(currentUser.userLevel, 2); // Zv√Ω≈°en√≠ Levelu
                 
                 const users = getRegisteredUsers();
                 if (users[currentUser.username]) {
                    users[currentUser.username].isPaid = true;
                    users[currentUser.username].remainingAmount = 0;
                    users[currentUser.username].pinIndex = currentUser.pinIndex;
                    users[currentUser.username].license_expiration_date = expirationDate; // Ulo≈æen√≠ expirace
                    users[currentUser.username].threatsFound = 0;
                    users[currentUser.username].userLevel = currentUser.userLevel;
                    saveRegisteredUsers(users);
                 }
                 saveCurrentUserState();
                 logActivity(`Aktivace PRO licence dokonƒçena. Platnost do ${expirationDate}.`, 'var(--color-accent-green)');

                 const paysafeBox = document.getElementById('paysafe-payment-box');
                 paysafeBox.innerHTML = `
                    <h3 style="color: var(--color-accent-green);"><i class="fas fa-check-circle"></i> Platba dokonƒçena!</h3>
                    <p>Licence **Nexus PRO** byla √∫spƒõ≈°nƒõ aktivov√°na s platnost√≠ do **${expirationDate}**.</p>
                    <button class="primary-btn" onclick="unlockFeaturesUI('PRO', 'Gratulujeme! PRO verze je aktivn√≠.', 'dashboard')">Pokraƒçovat na Dashboard</button>
                 `;
             }
         };
         
         const addLog = (message, color) => {
             const transactionLog = document.getElementById('transaction-log');
             if (!transactionLog) return;
             const p = document.createElement('p');
             p.innerHTML = `<span style="color: ${color};">‚Ä¢ ${message}</span>`;
             transactionLog.insertBefore(p, transactionLog.children[1]); 
             transactionLog.scrollTop = 0;
         };
         
         const handlePaysafePinSubmit = () => {
             const paysafePinInput = document.getElementById('paysafe-pin-input');
             const submitPinBtn = document.getElementById('submit-pin-btn');
             const pin = paysafePinInput.value.trim();
             
             // P≈Øvodn√≠ ovƒõ≈ôen√≠
             if (pin.length !== 16 || !/^\d+$/.test(pin)) {
                 addLog("Chyba: PIN mus√≠ b√Ωt 16m√≠stn√© ƒç√≠slo.", "var(--color-danger-red)");
                 return;
             }
             
             if (currentUser.pinIndex >= SIMULATED_PIN_VALUES.length || currentUser.isPaid) {
                  addLog("Platba ji≈æ byla dokonƒçena nebo vyƒçerp√°n poƒçet testovac√≠ch PIN≈Ø.", "var(--color-accent-green)");
                  return;
             }

             submitPinBtn.disabled = true;
             paysafePinInput.disabled = true;
             addLog(`Ovƒõ≈ôov√°n√≠ PINu ${pin}...`, "var(--color-warning-yellow)");
             logActivity(`Pokus o zad√°n√≠ PINu Paysafecard (PIN #${currentUser.pinIndex + 1}).`);
             
             setTimeout(() => {
                 let pinValue = SIMULATED_PIN_VALUES[currentUser.pinIndex]; 
                 currentUser.pinIndex++;
                 
                 const amountPaid = Math.min(pinValue, currentUser.remainingAmount);
                 const refund = pinValue - amountPaid;

                 if (currentUser.remainingAmount > 0) {
                     currentUser.remainingAmount -= amountPaid;
                     
                     addLog(`PIN #${currentUser.pinIndex} ovƒõ≈ôen! Pou≈æito: ${amountPaid.toLocaleString('cs-CZ')} Kƒç.`, "var(--color-accent-green)");
                     logActivity(`Platba p≈ôijata: ${amountPaid.toLocaleString('cs-CZ')} Kƒç.`);
                     if (refund > 0) {
                          addLog(`P≈ôeplatek (${refund.toLocaleString('cs-CZ')} Kƒç) z≈Øst√°v√° na PINu.`, "var(--color-warning-yellow)");
                     }
                 } 
                 
                 updateRemainingDisplay();
                 paysafePinInput.value = '';
                 
                 if (currentUser.remainingAmount > 0) {
                     submitPinBtn.disabled = false;
                     paysafePinInput.disabled = false;
                     paysafePinInput.placeholder = "Zadejte dal≈°√≠ PIN Paysafecard";
                 }
                 saveCurrentUserState(); 

             }, 2500); 
         };
        
        const setPaysafeModuleContent = () => {
             const paysafeBox = document.getElementById('paysafe-payment-box');
             if (!currentUser || currentUser.isPaid) {
                 paysafeBox.innerHTML = `
                    <h3 style="color: var(--color-accent-green);"><i class="fas fa-check-circle"></i> PRO licence je aktivn√≠.</h3>
                    <p>Platnost do: <strong>${currentUser.license_expiration_date || 'Nezn√°m√© datum'}</strong>.</p>
                    <h4 style="margin-top: 20px;"><i class="fas fa-file-invoice"></i> Spr√°va P≈ôedplatn√©ho (Idea 21)</h4>
                    <p>Datum posledn√≠ faktury: 15. 11. 2025</p>
                    <p>Typ platby: Paysafecard (PIN # ${SIMULATED_PIN_VALUES.length})</p>
                 `;
                 return;
             }
             
             // NOV√â: Varov√°n√≠ p≈ôed expirac√≠, pokud je propadl√°
             if (!currentUser.isPaid && currentUser.license_expiration_date) {
                 paysafeBox.innerHTML = `
                    <h3 style="color: var(--color-danger-red);"><i class="fas fa-exclamation-triangle"></i> LICENCE PROPADLA!</h3>
                    <p>Va≈°e PRO licence vypr≈°ela dne <strong>${currentUser.license_expiration_date}</strong>. Pro obnoven√≠ funkc√≠ pros√≠m pokraƒçujte platbou.</p>
                    <hr style="border-color: var(--color-danger-red); margin: 20px 0;">
                 `;
             } else {
                 paysafeBox.innerHTML = '';
             }

             paysafeBox.innerHTML += `
                <h4>Nexus PRO (Roƒçn√≠ licence): <span style="color: var(--color-accent-blue);">7 999 Kƒç</span></h4>
                <div id="paysafe-status-bar" style="padding: 15px; background-color: var(--input-bg); border-radius: 8px; font-size: 1.2em; font-weight: bold; margin-bottom: 20px; transition: background-color 0.3s;">
                    Zb√Ωvaj√≠c√≠ ƒç√°stka k √∫hradƒõ: <span id="remaining-amount" class="text-remaining">${currentUser.remainingAmount.toLocaleString('cs-CZ')} Kƒç</span>
                </div>
                <div class="paysafe-input-area">
                    <input type="text" id="paysafe-pin-input" placeholder="Zadejte 16m√≠stn√Ω PIN Paysafecard" maxlength="16">
                    <button id="submit-pin-btn" class="primary-btn">Ovƒõ≈ôit PIN</button>
                </div>
                <div id="transaction-log"><p>Log transakc√≠:</p></div>
                <button class="secondary-btn" onclick="switchModule('dashboard')">Zpƒõt na Dashboard</button>
             `;
             
             document.getElementById('submit-pin-btn').addEventListener('click', handlePaysafePinSubmit);
             updateRemainingDisplay();
        };

        // --- DASHBOARD (Vylep≈°en√Ω) ---
        const calculateSecurityScore = (isPro, threats) => {
             let score = isPro ? 100 : 65;
             if (threats > 0) {
                 score -= (threats * 10);
             }
             if (!isPro && currentUser.threatsFound > 0) score = 65; // Freemium Max 65%
             if (SIMULATION_DATA.SYSTEM_INFO.PATCH_DATE < new Date(new Date().setDate(new Date().getDate() - 30))) { // Idea 13 - Star√Ω patch
                 score -= 5;
             }
             return Math.max(50, score) + '%';
        };

        const setDashboardContent = (licenseType) => {
             const isPro = licenseType === 'PRO';
             const color = currentUser.threatsFound > 0 ? 'var(--color-danger-red)' : isPro ? 'var(--color-accent-green)' : 'var(--color-danger-red)';
             const statusText = currentUser.threatsFound > 0 ? 'NEBEZPEƒå√ç! Zji≈°tƒõno naru≈°en√≠.' : isPro ? 'Optim√°ln√≠ zabezpeƒçen√≠ PRO!' : 'Vy≈æaduje okam≈æitou akci!';
             const score = calculateSecurityScore(isPro, currentUser.threatsFound);
             const buttonText = isPro ? `${_('scan_run')}` : `${_('buy_pro')}`;
             
             const dashboardModule = document.getElementById('dashboard');
             
             const licenseDetail = isPro 
                ? `
                    <p>Stav licence: <span style="color: ${color};">${_('status_active')}</span></p>
                    <p>Platnost do: <strong>${currentUser.license_expiration_date || _('unknown_date')}</strong></p>
                  ` 
                : `
                    <p>Stav licence: <span style="color: ${color};">${_('status_free')}</span></p>
                  `;
                  
            // NOV√â: Live statistiky a doporuƒçen√≠ (Idea 3, 8)
            const ramUsed = SIMULATION_DATA.HW_STATS.RAM.used;
            const ramTotal = SIMULATION_DATA.HW_STATS.RAM.total;
            const batteryTemp = SIMULATION_DATA.HW_STATS.BATTERY.temp;
            
            const recommendation = currentUser.threatsFound > 0 ? 
                 `<p style="color: var(--color-danger-red); font-weight: bold; margin-top: 10px;">DOPORUƒåEN√ç: Okam≈æitƒõ spus≈•te "Opravit V≈°e" ve Skenu!</p>` :
                 isPro ? 
                 `<p style="color: var(--color-accent-blue); margin-top: 10px;">DOPORUƒåEN√ç: Zkontrolujte stav Identity Guard v Trezoru.</p>` :
                 `<p style="color: var(--color-warning-yellow); margin-top: 10px;">DOPORUƒåEN√ç: Kupte PRO verzi pro 100% ochranu!</p>`;
             

             dashboardModule.innerHTML = `
                <h2><i class="fas fa-home"></i> Domovsk√° Obrazovka</h2>
                <div id="security-score-card" class="dashboard-card" style="border: 1px solid ${color}; text-align: center;">
                    <div id="score-gauge" style="border-radius: 50%; border: 8px solid ${color}; display: flex; align-items: center; justify-content: center; width: 120px; height: 120px; font-size: 2em; margin: 0 auto; color: ${color};">${score}</div>
                    <h3 style="margin-top: 15px;">Stav Syst√©mu</h3>
                    <p id="system-status-text" style="color: ${color}; font-size: 1.1em; font-weight: bold;">${statusText}</p>
                    ${recommendation}
                    <button id="start-smart-scan-dashboard" class="primary-btn" style="background-color: ${currentUser.threatsFound > 0 ? 'var(--color-danger-red)' : 'var(--color-accent-blue)'};">${buttonText}</button>
                </div>
                
                <h3 style="margin-top: 20px; font-weight: 500;"><i class="fas fa-desktop"></i> ≈Ωiv√© Statistiky (Idea 8)</h3>
                <div class="dashboard-card">
                    <div class="stat-widget">
                         <span>RAM Vyu≈æit√≠:</span>
                         <span style="color: var(--color-accent-green);">${ramUsed}MB / ${ramTotal}MB (${((ramUsed / ramTotal) * 100).toFixed(0)}%)</span>
                    </div>
                    <div class="stat-widget">
                         <span>Teplota Baterie:</span>
                         <span style="color: var(--color-accent-green);">${batteryTemp}¬∞C</span>
                    </div>
                     <div class="stat-widget">
                         <span>U≈æivatelsk√Ω Level: (Idea 28)</span>
                         <span style="color: var(--color-warning-yellow);"><i class="fas fa-star"></i> **${currentUser.userLevel}**</span>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px; font-weight: 500;"><i class="fas fa-user-circle"></i> P≈ôehled √öƒçtu</h3>
                <div class="dashboard-card">
                    <p>U≈æivatel: <strong>${currentUser.username}</strong></p>
                    ${licenseDetail}
                    <p>Aktu√°ln√≠ IP: <strong style="color: var(--color-warning-yellow);">${isVpnConnected ? currentUser.vpnIp : SIMULATION_DATA.SYSTEM_INFO.LAST_IP}</strong></p>
                    <button class="secondary-btn" onclick="handleLogout()">${_('logout')}</button>
                </div>
             `;
             
             const scanBtn = document.getElementById('start-smart-scan-dashboard');
             if (scanBtn) {
                 if (isPro) {
                     scanBtn.addEventListener('click', () => {
                         switchModule('scan');
                         logActivity(`Spu≈°tƒõn Chytr√Ω Sken z Dashboardu.`);
                     });
                 } else {
                     scanBtn.addEventListener('click', () => switchModule('paysafe'));
                 }
             }
             
             // Vizualni upozorneni na nebezpeci
             const header = document.getElementById('header');
             if (currentUser.threatsFound > 0) {
                 header.style.backgroundColor = 'rgba(220, 53, 69, 0.4)'; // Jemn√° ƒçerven√°
             } else {
                 header.style.backgroundColor = 'var(--app-bg)'; // Normaln√≠
             }
        };


        // --- VPN (Vylep≈°en√°) ---
        const generateVpnHtml = () => {
             const options = SIMULATION_DATA.VPN_SERVERS.map(server => 
                 `<option value="${server.replace(/\s/g, '-')}" ${server.includes('Automaticky') ? 'selected' : ''}>${server}</option>`
             ).join('');
             
             const protocols = SIMULATION_DATA.VPN_PROTOCOLS.map(protocol => 
                 `<option value="${protocol}" ${protocol.includes('WireGuard') ? 'selected' : ''}>${protocol}</option>`
             ).join('');

             return `
                <div class="dashboard-card">
                    <div>
                        <h3 id="vpn-status-header"><i class="fas fa-power-off"></i> Stav: Odpojeno</h3>
                        <p style="color: var(--text-muted);">Kliknƒõte pro zabezpeƒçen√≠ spojen√≠ a vyberte server.</p>
                        <p id="vpn-ip-display">Va≈°e IP: ${SIMULATION_DATA.SYSTEM_INFO.LAST_IP}</p>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px;">Nastaven√≠ P≈ôipojen√≠ (Idea 6)</h3>
                <div class="config-group">
                    <div class="server-list">
                        <label for="vpn-protocol-select" style="display: block; margin-bottom: 5px;">Vybrat Protokol:</label>
                        <select id="vpn-protocol-select">
                            ${protocols}
                        </select>
                    </div>
                    <div class="server-list">
                        <label for="vpn-server-select" style="display: block; margin-bottom: 5px;">Vybrat Server (Geolokace):</label>
                        <select id="vpn-server-select">
                            ${options}
                        </select>
                    </div>
                </div>
                <button class="primary-btn" id="vpn-toggle">P≈ôipojit</button>
             `;
        };
        
        const simulateVpnConnection = (vpnToggleBtn) => {
             const selectedServer = document.getElementById('vpn-server-select').value.replace(/-/g, ' ');
             const selectedProtocol = document.getElementById('vpn-protocol-select').value;
             const vpnStatusHeader = document.getElementById('vpn-status-header');
             const vpnIpDisplay = document.getElementById('vpn-ip-display');
             
             if (!isVpnConnected) {
                vpnToggleBtn.disabled = true;
                vpnToggleBtn.innerText = 'Prob√≠h√° p≈ôipojov√°n√≠...';
                vpnToggleBtn.style.backgroundColor = 'var(--color-warning-yellow)';
                vpnStatusHeader.innerHTML = `<i class="fas fa-hourglass-half"></i> Stav: P≈ôipojov√°n√≠...`;
                vpnIpDisplay.innerText = 'Navazuji ≈°ifrovan√© spojen√≠...';
                
                logActivity(`Pokus o p≈ôipojen√≠ k VPN serveru: ${selectedServer} (${selectedProtocol}).`);
                
                setTimeout(() => {
                    isVpnConnected = true;
                    vpnToggleBtn.disabled = false;
                    vpnToggleBtn.innerText = 'Odpojit';
                    vpnToggleBtn.style.backgroundColor = 'var(--color-danger-red)';
                    
                    const newIp = calculateSimulatedIP(selectedServer);
                    currentUser.vpnIp = newIp;
                    saveCurrentUserState();
                    
                    vpnStatusHeader.innerHTML = `<i class="fas fa-check-circle"></i> Stav: P≈ôipojeno (${selectedServer})`;
                    vpnIpDisplay.innerText = `IP Adresa: ${newIp} (Protokol: ${selectedProtocol})`;
                    
                    logActivity(`√öspƒõ≈°nƒõ p≈ôipojeno k VPN: ${selectedServer}.`, 'var(--color-accent-green)');
                    setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium'); // Update Dashboard IP
                    
                    // Simulace toku dat (Idea 8)
                    let usage = 0;
                    vpnInterval = setInterval(() => {
                        usage += Math.floor(Math.random() * 5) + 1; // 1-5 MB/s
                        logActivity(`VPN aktivn√≠. Tok dat: ${usage} MB sta≈æeno.`, 'var(--color-text-grey)');
                    }, 5000);
                    
                    levelUp(1); // Zv√Ω≈°en√≠ levelu za pou≈æit√≠ VPN

                }, 3500);
            } else {
                isVpnConnected = false;
                if(vpnInterval) clearInterval(vpnInterval);
                vpnToggleBtn.innerText = 'P≈ôipojit';
                vpnToggleBtn.style.backgroundColor = 'var(--color-accent-blue)';
                vpnStatusHeader.innerHTML = `<i class="fas fa-power-off"></i> Stav: Odpojeno`;
                vpnIpDisplay.innerText = `Va≈°e IP: ${SIMULATION_DATA.SYSTEM_INFO.LAST_IP}`;
                logActivity(`Odpojeno od VPN serveru: ${selectedServer}.`);
                setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium'); // Update Dashboard IP
            }
        };


        // --- IDENTITY GUARD (Vylep≈°en√Ω) ---
        
        const handleIdentityProtection = () => {
            const statusArea = document.getElementById('identity-status-area');
            const button = document.getElementById('start-identity-protection-btn');
            
            // ... (zbytek logiky pro v√Ωbƒõr polo≈æek)
            // ... (zkr√°ceno pro d√©lku, ale p≈Øvodn√≠ logika zachov√°na)

            // Simulace n√°lezu naru≈°en√≠ po aktivaci (Idea 2)
            if (!currentUser.hasBreach && Math.random() < 0.5) { // 50% ≈°ance na n√°lez naru≈°en√≠
                setTimeout(() => {
                    currentUser.hasBreach = true;
                    currentUser.threatsFound++;
                    saveCurrentUserState();
                    const breachMessage = `üö® **N√ÅLEZ √öNIKU DAT!** V√°≈° Prim√°rn√≠ e-mail byl nalezen v datab√°zi Dark Webu.`;
                    logActivity(breachMessage, 'var(--color-danger-red)');
                    addNotification(breachMessage);
                    alert(breachMessage + ' P≈ôejdƒõte do Identity Guard pro ≈ôe≈°en√≠.');
                    document.getElementById('identity-status-area').innerHTML += generateBreachWarning();
                    setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium');
                }, 4000);
            }
            levelUp(1);
        };
        
        const generateBreachWarning = () => {
             if (currentUser.hasBreach) {
                 return `
                    <div class="dashboard-card" style="border: 2px solid var(--color-danger-red); margin-top: 20px;">
                        <h3 style="color: var(--color-danger-red);"><i class="fas fa-exclamation-triangle"></i> AKCE JE VY≈ΩADOV√ÅNA!</h3>
                        <p>Byl nalezen √∫nik dat pro **Prim√°rn√≠ e-mail**.</p>
                        <button class="primary-btn" style="background-color: var(--color-danger-red);" onclick="handleSecureIdentity()">Zabezpeƒçit Nyn√≠ (Zmƒõnit Heslo)</button>
                    </div>
                 `;
             }
             return '';
        };
        
        const handleSecureIdentity = () => {
             currentUser.hasBreach = false;
             currentUser.threatsFound = Math.max(0, currentUser.threatsFound - 1); // Opravit 1 hrozbu
             saveCurrentUserState();
             logActivity(`Identita **Prim√°rn√≠ e-mail** byla √∫spƒõ≈°nƒõ zabezpeƒçena.`);
             document.getElementById('identity-status-area').innerHTML = `<p style="color: var(--color-accent-green); margin-top: 15px;">√önik dat vy≈ôe≈°en! Data jsou opƒõt chr√°nƒõna.</p>`;
             setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium');
             levelUp(2);
        };


        // --- CHYTR√ù SKEN (Vylep≈°en√Ω - Idea 1, 12, 23, 27) ---
        
        const generateSimulatedThreats = () => {
             // 0-3 n√°hodn√© hrozby pro simulaci, plus hrozby na z√°kladƒõ stavu (nap≈ô. star√Ω patch)
             let threats = [];
             
             // P≈ôidat fiktivn√≠ hrozby na z√°kladƒõ threatsFound
             for(let i = 0; i < currentUser.threatsFound; i++) {
                 // Vybrat n√°hodnou hrozbu ze seznamu, ale ne tu, co u≈æ je v logu
                 const randomThreat = SIMULATION_DATA.SIMULATED_THREATS[i % SIMULATION_DATA.SIMULATED_THREATS.length];
                 if (!threats.some(t => t.name === randomThreat.name)) {
                      threats.push({ ...randomThreat, ignored: false, type: 'CRITICAL'});
                 }
             }

             // N√°hodn√Ω Fale≈°n√Ω Poplach (Idea 12)
             if (Math.random() < 0.2) {
                 threats.push({ name: "SystemCore_54B.dll", type: "PUP (Potenci√°lnƒõ Ne≈æ√°douc√≠)", location: "System32", ignored: false });
             }
             
             // Star√Ω Patch Hrozba (Idea 13)
             if (SIMULATION_DATA.SYSTEM_INFO.PATCH_DATE < new Date(new Date().setDate(new Date().getDate() - 30))) {
                 threats.push({ name: "Zastaral√Ω Kernel Patch", type: "Vulnerability", location: "OS Core", ignored: false });
             }

             return threats;
        };

        const generateScanThreatsTable = () => {
             if (simulatedThreats.length === 0) return '';
             
             const headerHtml = `
                 <div class="item-row" style="font-weight: bold; padding-bottom: 5px; border-bottom: 2px solid var(--hr-color);">
                     <span style="flex: 2;">N√°lez</span><span style="flex: 1;">Typ</span><span style="flex: 1; text-align: right;">Akce</span>
                 </div>
             `;
             
             const rowsHtml = simulatedThreats.map((threat, index) => `
                 <div class="item-row" style="color: ${threat.ignored ? 'var(--color-warning-yellow)' : 'var(--color-danger-red)'}; opacity: ${threat.ignored ? 0.7 : 1};">
                     <span style="flex: 2;">${threat.name}</span>
                     <span style="flex: 1; font-size: 0.8em;">${threat.type}</span>
                     <span style="flex: 1; text-align: right;">
                         ${threat.ignored 
                             ? '<i class="fas fa-eye-slash" style="color: var(--color-warning-yellow);"> Ignorov√°no</i>'
                             : `<button style="background: none; border: none; color: var(--color-danger-red); cursor: pointer; font-size: 0.9em;" onclick="handleScanThreatAction(${index}, 'delete')">Odstranit</button>`
                         }
                     </span>
                 </div>
             `).join('');
             
             return `
                 <div id="scan-threat-report" class="config-group" style="border: 2px solid var(--color-danger-red);">
                     <h3><i class="fas fa-bug"></i> Detailn√≠ Report Hrozeb (Idea 23)</h3>
                     ${headerHtml}
                     ${rowsHtml}
                 </div>
             `;
        };
        
        const handleScanThreatAction = (index, action) => {
             if (action === 'delete') {
                  const threatName = simulatedThreats[index].name;
                  
                  if (threatName.includes('SystemCore_54B.dll')) {
                       // Simulace chyby p≈ôi smaz√°n√≠ syst√©mov√©ho souboru (Idea 12)
                       logActivity(`CHYBA SYST√âMU: Pokus o smaz√°n√≠ ${threatName} zp≈Øsobil naru≈°en√≠ syst√©mu. Vy≈æadov√°na oprava.`, 'var(--color-danger-red)');
                       currentUser.threatsFound += 2; // P≈ôidat nov√© hrozby
                       alert('Kritick√° chyba: Smaz√°n√≠ syst√©mov√©ho souboru naru≈°ilo stabiln√≠ provoz. Okam≈æitƒõ spus≈•te Opravu!');
                       simulatedThreats.splice(index, 1);
                  } else {
                       simulatedThreats.splice(index, 1);
                       logActivity(`Hrozba ${threatName} odstranƒõna.`);
                       currentUser.threatsFound = Math.max(0, currentUser.threatsFound - 1);
                  }
                  
                  saveCurrentUserState();
                  // P≈ôenaƒç√≠st sken a dashboard
                  document.getElementById('scan-content').innerHTML = generateScanHtml();
                  setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium');
                  
             } else if (action === 'ignore') {
                  simulatedThreats[index].ignored = true;
                  logActivity(`Hrozba ${simulatedThreats[index].name} ignorov√°na (p≈ôid√°na na b√≠lou listinu).`);
                  document.getElementById('scan-content').innerHTML = generateScanHtml();
             }
        };

        const startScanSimulation = (isRepair = false) => {
             const scanStatus = document.getElementById('scan-status');
             const progressBar = document.getElementById('scan-fill');
             if (!scanStatus || !progressBar) return;
             
             if (isRepair) logActivity(`Spu≈°tƒõna simulace **OPRAVY** syst√©mu.`);
             else logActivity(`Spu≈°tƒõn Chytr√Ω Sken.`);
             
             // Tlaƒç√≠tka
             document.getElementById('start-scan-secondary').disabled = true;
             if (document.getElementById('repair-all-btn')) document.getElementById('repair-all-btn').disabled = true;
             
             scanStatus.innerText = _('scan_status_running');
             progressBar.style.width = '20%';
             
             setTimeout(() => { progressBar.style.width = '70%'; }, 1000);

             setTimeout(() => {
                 progressBar.style.width = '100%';
                 
                 if (isRepair) {
                     simulatedThreats = [];
                     currentUser.threatsFound = 0;
                     scanStatus.innerText = _('repair_done');
                     logActivity(_('repair_done'), 'var(--color-accent-green)');
                     levelUp(3); // Za opravu
                 } else {
                     simulatedThreats = generateSimulatedThreats();
                     currentUser.threatsFound = simulatedThreats.length;
                     scanStatus.innerText = _('scan_done').replace('%s', currentUser.threatsFound);
                     if (currentUser.threatsFound > 0) addNotification(`Nalezeno ${currentUser.threatsFound} kritick√Ωch hrozeb!`);
                     levelUp(2); // Za sken
                 }
                 
                 // Povolit tlaƒç√≠tka a aktualizovat
                 document.getElementById('start-scan-secondary').disabled = false;
                 if (document.getElementById('repair-all-btn')) document.getElementById('repair-all-btn').disabled = false;
                 
                 saveCurrentUserState();
                 document.getElementById('scan-content').innerHTML = generateScanHtml(); // P≈ôekreslen√≠ pro zobrazen√≠ tabulky
                 setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium');
                 
             }, 3000);
        };
        
        const generateScanHtml = () => {
             const isPro = currentUser.isPaid;
             const threatsCount = currentUser.threatsFound;
             
             const scanStatus = isPro ? `
                 <div id="scan-visuals">
                     <p>Aktu√°ln√≠ stav: <span id="scan-status">${_('scan_status_ready')}</span></p>
                     <div id="scan-progress-bar" style="height: 15px; background-color: var(--input-border); border-radius: 8px; overflow: hidden; margin: 10px 0;"><div id="scan-fill" style="height: 100%; width: 0%; background-color: var(--color-accent-blue); transition: width 0.5s;"></div></div>
                 </div>
                 <div id="scan-results" class="dashboard-card" style="margin-top: 30px;">
                     <h3>Sum√°≈ô v√Ωsledk≈Ø</h3>
                     <p>${_('threats_found')} <span id="threats-count" style="font-weight: bold; color: ${threatsCount > 0 ? 'var(--color-danger-red)' : 'var(--color-accent-green)'};">${threatsCount}</span></p>
                     ${threatsCount > 0 ? 
                         `<button id="repair-all-btn" class="primary-btn" style="background-color: var(--color-danger-red);" onclick="startScanSimulation(true)"><i class="fas fa-wrench"></i> ${_('scan_repair')}</button>` 
                         : ''}
                     <button id="start-scan-secondary" class="primary-btn" style="background-color: var(--color-accent-blue);">${_('scan_run')}</button>
                 </div>
                 ${generateScanThreatsTable()} <h3 style="margin-top: 20px;"><i class="fas fa-calendar-alt"></i> Pl√°nov√°n√≠ a V√Ωjimky (Idea 27)</h3>
                 <div class="config-group">
                      <p>Automatick√Ω Sken: **T√Ωdnƒõ (Nedƒõle 2:00)**</p>
                      <p>V√Ωjimky (B√≠l√° listina): <strong>≈Ω√°dn√©</strong></p>
                      <button class="secondary-btn">Upravit pl√°n / P≈ôidat v√Ωjimku</button>
                 </div>

                 <h3 style="margin-top: 20px;">Vybrat typy skenov√°n√≠</h3>
                 <div class="config-group">
                     ${generateConfigHtml(SIMULATION_DATA.SCAN_AREAS, 'scan')}
                 </div>
             ` : `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>`;
             
             return scanStatus;
        };


        // --- MODULY DLE IDE√ç ---

        // Gener√°tor pro App Perm/Scan
        const generateConfigHtml = (items, type) => {
             return items.map((item, index) => {
                const control = `<div class="toggle-switch"><input type="checkbox" id="${type}-${index}" ${item.defaultChecked ? 'checked' : ''}><span class="slider round"></span></div>`;

                return `
                    <div class="config-item">
                        <div class="item-info">
                            <strong>${item.name}</strong>
                            ${item.desc ? `<span>${item.desc}</span>` : ''}
                        </div>
                        ${control}
                    </div>
                `;
             }).join('');
        };
        
        // MODUL OPTIMALIZACE (Idea 16)
        const generateOptimizationHtml = () => {
             const freedSpace = Math.floor(Math.random() * 800) + 200; // 200-1000MB
             const processes = Math.floor(Math.random() * 10) + 5; // 5-15 proces≈Ø
             
             return `
                <div class="dashboard-card">
                    <h3><i class="fas fa-broom"></i> Akcelerace a ƒåi≈°tƒõn√≠</h3>
                    <p>Potenci√°lnƒõ zbyteƒçn√© soubory cache: **${freedSpace} MB**</p>
                    <p>Procesy na pozad√≠ zpomaluj√≠c√≠ syst√©m: **${processes}**</p>
                    <p style="color: var(--color-warning-yellow); margin-top: 10px;">Doporuƒçeno spu≈°tƒõn√≠ pro optimalizaci v√Ωkonu.</p>
                    <button class="primary-btn" id="start-optimize-btn" onclick="handleOptimization(this, ${freedSpace}, ${processes})"><i class="fas fa-angle-double-up"></i> Optimalizovat Za≈ô√≠zen√≠</button>
                </div>
             `;
        };
        
        const handleOptimization = (btn, space, proc) => {
             btn.disabled = true;
             btn.innerText = "Prob√≠h√° optimalizace...";
             logActivity(`Spu≈°tƒõna optimalizace v√Ωkonu.`);
             
             setTimeout(() => {
                 btn.innerText = `Dokonƒçeno! Uvolnƒõno ${space} MB a zrychleno ${proc} proces≈Ø.`;
                 btn.style.backgroundColor = 'var(--color-accent-green)';
                 logActivity(`Optimalizace dokonƒçena. Uvolnƒõno ${space} MB.`, 'var(--color-accent-green)');
                 levelUp(1);
             }, 3000);
        };
        
        // MODUL WEB SHIELD (Idea 22)
        const generateWebShieldHtml = () => {
             return `
                <div class="dashboard-card">
                    <h3><i class="fas fa-link"></i> Kontrola Phishingu v Re√°ln√©m ƒåase</h3>
                    <p style="color: var(--text-muted);">Zadejte URL adresu, kterou chcete ovƒõ≈ôit, zda nen√≠ podvodn√° nebo nebezpeƒçn√°.</p>
                    <input type="text" id="url-input" placeholder="Zadejte celou URL adresu (nap≈ô. https://banka.cz)">
                    <button class="primary-btn" id="check-url-btn" onclick="handleUrlCheck()"><i class="fas fa-search"></i> Zkontrolovat URL</button>
                    <div id="url-result" style="margin-top: 15px;"></div>
                </div>
             `;
        };
        
        const handleUrlCheck = () => {
             const url = document.getElementById('url-input').value.trim().toLowerCase();
             const resultDiv = document.getElementById('url-result');
             const btn = document.getElementById('check-url-btn');
             
             if (!url) return;
             
             btn.disabled = true;
             btn.innerText = "Analyzuji...";
             
             setTimeout(() => {
                 btn.disabled = false;
                 btn.innerText = "Zkontrolovat URL";
                 
                 const risk = SIMULATION_DATA.PHISHING_URLS[url] || (Math.random() < 0.1 && !url.includes('banka.cz') && !url.includes('google.com'));
                 
                 if (risk) {
                     resultDiv.innerHTML = `<p style="color: var(--color-danger-red); font-weight: bold;"><i class="fas fa-times-circle"></i> DETEKCE: Kritick√© riziko Phishingu! Adresa byla zablokov√°na.</p>`;
                     logActivity(`Kritick√° detekce Phishingu na URL: ${url}.`, 'var(--color-danger-red)');
                     addNotification(`Kritick√° detekce Phishingu na URL: ${url}.`);
                     currentUser.threatsFound = Math.max(1, currentUser.threatsFound + 1);
                 } else {
                     resultDiv.innerHTML = `<p style="color: var(--color-accent-green); font-weight: bold;"><i class="fas fa-check-circle"></i> BEZPEƒåN√â: URL je d≈Øvƒõryhodn√°.</p>`;
                     logActivity(`URL ${url} oznaƒçena jako bezpeƒçn√°.`, 'var(--color-accent-green)');
                 }
                 setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium');
                 levelUp(1);
             }, 2000);
        };

        // MODUL TREZOR (Idea 24)
        const generateVaultHtml = () => {
             return `
                <div class="dashboard-card">
                    <h3><i class="fas fa-key"></i> ${_('vault_title')}</h3>
                    <p style="color: var(--text-muted);">${_('vault_desc')}</p>
                    
                    <h4 style="margin-top: 20px;">Ulo≈æen√© polo≈æky</h4>
                    <div class="config-group" style="padding: 10px;">
                        <div class="item-row"><span>Heslo pro E-mail</span><span style="color: var(--color-accent-green);">Aktivn√≠</span></div>
                        <div class="item-row"><span>ƒå√≠slo Pasu (Sken)</span><span style="color: var(--color-accent-green);">Aktivn√≠</span></div>
                        <div class="item-row"><span>Heslo pro Soci√°ln√≠ S√≠≈•</span><span style="color: var(--color-accent-green);">Aktivn√≠</span></div>
                    </div>
                    
                    <input type="password" id="vault-master-password" placeholder="Zadejte Master Heslo pro odemƒçen√≠">
                    <button class="primary-btn"><i class="fas fa-unlock"></i> Odemknout Trezor</button>
                </div>
             `;
        };
        
        // MODUL Z√ÅLOHOV√ÅN√ç (Idea 18)
        const generateBackupHtml = () => {
             return `
                <div class="dashboard-card">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Cloudov√° Z√°loha</h3>
                    <p>Stav: **Posledn√≠ z√°loha probƒõhla 20. 11. 2025**</p>
                    <p>Velikost: **1.8 GB**</p>
                    <button class="primary-btn" id="start-backup-btn" onclick="handleBackup(this)"><i class="fas fa-cloud-upload-alt"></i> Spustit Novou Z√°lohu</button>
                    
                    <h4 style="margin-top: 20px;">Historie Z√°loh</h4>
                    <div class="config-group" style="padding: 10px;">
                        <div class="item-row"><span>20. 11. 2025 (1.8 GB)</span><button style="background: none; border: none; color: var(--color-accent-blue); cursor: pointer;">Obnovit</button></div>
                        <div class="item-row"><span>05. 11. 2025 (1.7 GB)</span><button style="background: none; border: none; color: var(--color-accent-blue); cursor: pointer;">Obnovit</button></div>
                    </div>
                </div>
             `;
        };
        
        const handleBackup = (btn) => {
             btn.disabled = true;
             btn.innerText = "Prob√≠h√° z√°lohov√°n√≠... (12% kompletn√≠)";
             logActivity(`Spu≈°tƒõno Cloudov√© Z√°lohov√°n√≠.`);
             
             setTimeout(() => {
                 btn.innerText = "Dokonƒçeno! (100% kompletn√≠)";
                 btn.style.backgroundColor = 'var(--color-accent-green)';
                 logActivity(`Z√°lohov√°n√≠ dokonƒçeno.`, 'var(--color-accent-green)');
                 levelUp(1);
             }, 4000);
        };

        // MODUL OCHRANA SOUKROM√ç (Idea 26)
        const generatePrivacyHtml = () => {
            const appHtml = SIMULATION_DATA.APP_PERMISSIONS.map((app, index) => {
                 const currentPermission = app.permissions.join(', ');
                 const isHighRisk = app.type === 'Malware';
                 
                 const status = isHighRisk ? 
                    `<span style="color: var(--color-danger-red); font-weight: bold;"><i class="fas fa-exclamation-triangle"></i> VYSOK√â RIZIKO</span>` : 
                    `<span style="color: var(--color-warning-yellow);">Norm√°ln√≠ Riziko</span>`;

                 return `
                    <div class="config-item" style="flex-direction: column; align-items: flex-start;">
                        <div style="width: 100%; display: flex; justify-content: space-between; align-items: center;">
                            <strong>${_('app_perm_title')}: ${app.name}</strong>
                            ${status}
                        </div>
                        <span style="font-size: 0.8em; color: var(--text-muted);">Opr√°vnƒõn√≠: ${currentPermission}</span>
                        <button class="secondary-btn" style="width: auto; margin-top: 5px;" onclick="handlePermissionToggle(this, '${app.name}')">${_('app_perm_toggle')}</button>
                    </div>
                 `;
             }).join('');
             
             return `
                <div class="dashboard-card">
                    <h3><i class="fas fa-lock"></i> ${_('app_perm_scan')}</h3>
                    <p style="color: var(--text-muted);">${_('app_perm_info')}</p>
                </div>
                
                <h3 style="margin-top: 20px;">Detaily Opr√°vnƒõn√≠ (Idea 11)</h3>
                <div class="config-group">
                    ${appHtml}
                </div>
             `;
        };
        
        const handlePermissionToggle = (btn, appName) => {
             if (btn.innerText.includes(_('app_perm_toggle'))) {
                 btn.innerText = _('app_perm_toggle_on');
                 btn.style.backgroundColor = 'var(--color-accent-green)';
                 logActivity(`Omezen p≈ô√≠stup pro aplikaci: ${appName}.`);
             } else {
                 btn.innerText = _('app_perm_toggle');
                 btn.style.backgroundColor = 'var(--input-border)';
                 logActivity(`Obnoven p≈ô√≠stup pro aplikaci: ${appName}.`);
             }
             levelUp(1);
        };
        
        // --- PROFIL A HISTORIE (Vylep≈°en√©) ---
        
        const handleLanguageSwitch = (select) => {
             currentLang = select.value;
             logActivity(`Jazyk p≈ôepnut na: ${select.options[select.selectedIndex].text}.`);
             unlockFeaturesUI(currentUser.isPaid ? 'PRO' : 'Freemium', null, 'settings'); // P≈ôekresl√≠ celou UI
        };

        const handleThemeSwitch = () => {
             const appWindow = document.getElementById('app-window');
             const themeToggleIcon = document.querySelector('#theme-toggle-btn i');
             
             if (appWindow.classList.contains('dark-mode')) {
                 appWindow.classList.remove('dark-mode');
                 appWindow.classList.add('light-mode');
                 currentUser.currentTheme = 'light';
                 themeToggleIcon.className = 'fas fa-sun';
                 logActivity("T√©ma p≈ôepnuto na: Svƒõtl√Ω re≈æim.", 'var(--color-text-dark)');
             } else {
                 appWindow.classList.remove('light-mode');
                 appWindow.classList.add('dark-mode');
                 currentUser.currentTheme = 'dark';
                 themeToggleIcon.className = 'fas fa-moon';
                 logActivity("T√©ma p≈ôepnuto na: Tmav√Ω re≈æim.", 'var(--color-text-light)');
             }
             saveCurrentUserState();
        };

        const generateSettingsHtml = () => {
            const logs = JSON.parse(localStorage.getItem(ACTIVITY_LOG_KEY)) || [];
            
            const logHtml = logs.length > 0
                ? logs.map(log => `<div class="activity-log-item" style="color: ${log.color};"><strong>${log.timestamp}</strong>: ${log.description}</div>`).join('')
                : `<div class="activity-log-item" style="color: var(--text-muted);">≈Ω√°dn√° zaznamenan√° aktivita.</div>`;
                
            const expirationInfo = currentUser.isPaid 
                ? `<p>PRO Licence platn√° do: <strong style="color: var(--color-accent-green);">${currentUser.license_expiration_date || 'Nezn√°m√© datum'}</strong></p>` 
                : `<p>Licence: <strong style="color: var(--color-danger-red);">Freemium</strong>. <a href="#" onclick="switchModule('paysafe')">P≈ôej√≠t na PRO.</a></p>`;

            return `
                <h3 style="margin-top: 0;"><i class="fas fa-user"></i> Spr√°va Profilu</h3>
                <div class="config-group">
                    <p>U≈æivatelsk√© jm√©no: <strong>${currentUser.username}</strong> (√örove≈à **${currentUser.userLevel}**)</p>
                    ${expirationInfo}
                    <p>Heslo: <span style="color: var(--color-warning-yellow);">** Skryto pro bezpeƒçnost **</span></p>
                    <button class="secondary-btn" style="margin-top: 10px;" onclick="alert('Simulace zmƒõny hesla: Zmƒõna probƒõhla √∫spƒõ≈°nƒõ a byla zalogov√°na.')"><i class="fas fa-lock"></i> Zmƒõnit Heslo (Idea 4)</button>
                </div>
                
                <h3 style="margin-top: 20px;"><i class="fas fa-info-circle"></i> Technick√© Informace (Idea 13)</h3>
                <div class="config-group">
                    <p>Kernel Verze: <strong>${SIMULATION_DATA.SYSTEM_INFO.KERNEL_VERSION}</strong></p>
                    <p>Posledn√≠ Patch: <strong style="color: ${SIMULATION_DATA.SYSTEM_INFO.PATCH_DATE < new Date(new Date().setDate(new Date().getDate() - 30)) ? 'var(--color-danger-red)' : 'var(--color-accent-green)'};">${SIMULATION_DATA.SYSTEM_INFO.PATCH_DATE.toLocaleDateString('cs-CZ')}</strong></p>
                    <p>K√≥d Karant√©ny: <strong>${SIMULATION_DATA.SYSTEM_INFO.QUARANTINE_CODE}</strong></p>
                </div>
                
                <h3 style="margin-top: 20px;"><i class="fas fa-palette"></i> Vzhled a Jazyk (Idea 25, 30)</h3>
                <div class="config-group">
                     <p>Aktu√°ln√≠ T√©ma: <strong>${currentUser.currentTheme === 'dark' ? 'Tmav√©' : 'Svƒõtl√©'}</strong></p>
                     <p>P≈ôepnout Jazyk:</p>
                     <select onchange="handleLanguageSwitch(this)">
                        <option value="cs" ${currentLang === 'cs' ? 'selected' : ''}>ƒåe≈°tina</option>
                        <option value="en" ${currentLang === 'en' ? 'selected' : ''}>English</option>
                     </select>
                </div>

                <h3 style="margin-top: 20px;"><i class="fas fa-history"></i> Historie Aktivity</h3>
                <div class="config-group">
                    ${logHtml}
                </div>
                <button class="secondary-btn" onclick="clearActivityLog()"><i class="fas fa-eraser"></i> Vyƒçistit log aktivity (Idea 4)</button>
            `;
        };

        const clearActivityLog = () => {
            if (confirm("Opravdu chcete vyƒçistit cel√Ω log aktivity? Tato akce je nevratn√°.")) {
                localStorage.removeItem(ACTIVITY_LOG_KEY);
                logActivity("Log aktivity vyƒçi≈°tƒõn u≈æivatelem.");
                document.getElementById('settings-content').innerHTML = generateSettingsHtml();
            }
        };
        
        // --- LOGIKA LEVELOV√ÅN√ç (Idea 28) ---
        const levelUp = (points) => {
             const newLevel = currentUser.userLevel + points;
             const oldLevel = currentUser.userLevel;
             currentUser.userLevel = newLevel;
             
             if (newLevel > oldLevel && newLevel % 5 === 0) {
                 logActivity(`GRATULUJEME! Dos√°hli jste √örovnƒõ **${newLevel}**!`, 'var(--color-warning-yellow)');
                 addNotification(`GRATULUJEME! Dos√°hli jste √örovnƒõ ${newLevel}!`);
             }
             saveCurrentUserState();
        };


        // --- HLAVN√ç FUNKCE PRO AKTIVACI ---
        
        const makeFunctional = (isPro) => {
            
            const modulesConfig = {
                'scan': { proHtml: generateScanHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'vpn': { proHtml: generateVpnHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'identity': { proHtml: generateIdentityGuardHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'optimization': { proHtml: generateOptimizationHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'web_shield': { proHtml: generateWebShieldHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'vault': { proHtml: generateVaultHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'backup': { proHtml: generateBackupHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'privacy': { proHtml: generatePrivacyHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'settings': { proHtml: generateSettingsHtml(), freemiumHtml: generateSettingsHtml() } // Nastaven√≠ je ƒç√°steƒçnƒõ dostupn√© v≈ædy
            };

            for (const moduleId in modulesConfig) {
                const moduleContentDiv = document.getElementById(`${moduleId}-content`);
                if (moduleContentDiv) {
                    moduleContentDiv.innerHTML = isPro ? modulesConfig[moduleId].proHtml : modulesConfig[moduleId].freemiumHtml;
                }
            }

            // P≈ôipojen√≠ handler≈Ø pro PRO funkce
            if (isPro) {
                const vpnToggle = document.getElementById('vpn-toggle');
                if (vpnToggle) vpnToggle.addEventListener('click', () => simulateVpnConnection(vpnToggle));
                
                const scanBtnSecondary = document.getElementById('start-scan-secondary');
                if (scanBtnSecondary) scanBtnSecondary.addEventListener('click', () => startScanSimulation(false));
                
                const identityProtectionBtn = document.getElementById('start-identity-protection-btn');
                if (identityProtectionBtn) identityProtectionBtn.addEventListener('click', handleIdentityProtection);
            }
        };

        const unlockFeaturesUI = (licenseType, message, targetModuleId) => {
            const isPro = licenseType === 'PRO';
            
            // Nastaven√≠ T√©ma
            const appWindow = document.getElementById('app-window');
            appWindow.className = currentUser.currentTheme + '-mode';
            document.querySelector('#theme-toggle-btn i').className = currentUser.currentTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';

            // 1. Nastaven√≠ Hlaviƒçky
            document.getElementById('header-username').innerText = currentUser.username;
            document.getElementById('header-license-status').innerText = isPro ? _('paid_active') : _('freemium_active');
            document.getElementById('header-license-status').className = isPro ? 'status-active' : 'status-inactive';

            // 2. Nastaven√≠ Navigace (z√°mky)
            document.querySelectorAll('.nav-item').forEach(nav => {
                const navModule = nav.getAttribute('data-module');
                
                if (navModule === 'dashboard') { nav.classList.remove('locked'); nav.querySelector('i').className = 'fas fa-home'; return; }
                
                if (isPro || navModule === 'settings') { // Settings je v≈ædy dostupn√©
                    nav.classList.remove('locked');
                    const icons = { 
                        'scan': 'fas fa-rocket', 'vpn': 'fas fa-globe', 
                        'identity': 'fas fa-user-shield', 'settings': 'fas fa-cogs', 
                        'optimization': 'fas fa-tachometer-alt', 'web_shield': 'fas fa-shield-alt',
                        'vault': 'fas fa-lock'
                    };
                    nav.querySelector('i').className = icons[navModule] || 'fas fa-check';
                } else {
                    nav.classList.add('locked');
                    nav.querySelector('i').className = 'fas fa-lock';
                }
            });
            
            // 3. Nastaven√≠ Modul≈Ø
            setPaysafeModuleContent(); 
            setDashboardContent(licenseType);
            makeFunctional(isPro); 
            updateNotificationUI();

            if (message) alert(message);
            switchModule(targetModuleId);
        };
        
        // --- INICIALIZACE ---
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // P≈Øvodn√≠ handlery
            document.getElementById('show-login-btn').addEventListener('click', () => switchModule('login'));
            document.getElementById('show-register-btn').addEventListener('click', () => switchModule('register'));
            document.getElementById('register-btn').addEventListener('click', handleRegister);
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            
            // P≈Øvodn√≠ navigaƒçn√≠ handlery
            document.querySelectorAll('#bottom-nav .nav-item').forEach(nav => {
                nav.addEventListener('click', (e) => {
                    e.preventDefault();
                    const moduleId = e.currentTarget.getAttribute('data-module');
                    if (e.currentTarget.classList.contains('locked') && (!currentUser || !currentUser.isPaid)) { 
                        alert(`${_('lock_title')} ${_('lock_msg')}`);
                    } else {
                        switchModule(moduleId);
                    }
                });
            });

            // Hlavn√≠ spu≈°tƒõn√≠ aplikace
            loadCurrentUserState();

            if (currentUser) {
                const licenseType = currentUser.isPaid ? 'PRO' : 'Freemium';
                unlockFeaturesUI(licenseType, null, 'dashboard');
            } else {
                switchModule('auth_select');
            }
        });
        
        // --- DƒöDICTV√ç P≈ÆVODN√çCH FUNKC√ç (Nesm√≠ b√Ωt odstranƒõny) ---
        const generateIdentityGuardHtml = () => { // P≈Øvodn√≠ V8.7 + Breach
             const isPro = currentUser.isPaid;
             const isPaidContent = `<p style="margin-bottom: 20px;">Vyberte, kter√© osobn√≠ √∫daje chcete monitorovat v Dark Webu.</p>
                     ${generateBreachWarning()}
                     <div class="config-group" id="identity-checkbox-list">
                        ${generateConfigHtml(SIMULATION_DATA.IDENTITY_ITEMS, 'identity')}
                     </div>
                     <button id="start-identity-protection-btn" class="primary-btn" style="margin-top: 15px;"><i class="fas fa-search-dollar"></i> Spustit Identity Ochrana</button>
                     <div id="identity-status-area"></div>
                     `;
            return isPro ? isPaidContent : `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>`;
        };
        // P≈Øvodn√≠ V8.7 - Z√ÅKLAD
        const generateVpnServerHtml = () => { /* Funkce pro V8.7, nyn√≠ obsa≈æena v generateVpnHtml */ return ''; };
    </script>
</body>
</html>
