<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Nexus Prime Security - V9.7 (Realistická Simulace)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- CSS STYLING V9.7 --- */
        :root {
            /* Původní Dark Mode */
            --color-dark-bg: #1e1e2c; 
            --color-darker-bg: #151520; 
            --color-text-light: #f0f0f5;
            --color-text-grey: #a0a0b0;
            --color-border: #303040;
            
            /* Společné barvy */
            --color-accent-blue: #007bff; 
            --color-accent-green: #28a745; 
            --color-danger-red: #dc3545;
            --color-warning-yellow: #ffc107;
            
            /* Světlý režim */
            --color-light-bg: #f5f5f5;
            --color-lighter-bg: #ffffff;
            --color-light-text-dark: #333333;
            --color-light-text-grey: #555555;
            --color-light-border: #cccccc;

            /* Dynamické proměnné pro téma (defaultně DARK) */
            --app-bg: var(--color-darker-bg);
            --module-bg: var(--color-dark-bg);
            --content-bg: #2a2a3b;
            --text-color: var(--color-text-light);
            --text-muted: var(--color-text-grey);
            --input-bg: var(--color-darker-bg);
            --input-border: var(--color-border);
            --nav-active: var(--color-accent-blue);
            --nav-inactive: var(--color-text-grey);
            --hr-color: var(--color-border);
            
             /* FIX: Lepší čitelnost v Light Mode */
            --button-text-light: #ffffff; 
        }
        
        /* Téma LIGHT MODE */
        .light-mode {
            --app-bg: var(--color-lighter-bg);
            --module-bg: var(--color-light-bg);
            --content-bg: var(--color-lighter-bg);
            --text-color: var(--color-light-text-dark);
            --text-muted: var(--color-light-text-grey);
            --input-bg: var(--color-lighter-bg); /* Input pozadí - Bílé */
            --input-border: var(--color-light-border); /* Input border - Šedý */
            --nav-active: var(--color-accent-blue);
            --nav-inactive: var(--color-light-text-grey);
            --hr-color: var(--color-light-border);
            
            --button-text-light: var(--color-light-text-dark); /* Sekundární tlačítka */
        }


        body {
            background-color: var(--app-bg); 
            color: var(--text-color);
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        #app-window {
            width: 400px; 
            height: 700px; 
            background-color: var(--module-bg);
            border-radius: 25px; 
            box-shadow: 0 20px 50px rgba(0 0 0 / 50%), 0 0 0 10px #000; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: background-color 0.3s;
        }

        /* HLAVIČKA */
        #header {
            background-color: var(--app-bg);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--hr-color);
            position: sticky;
            top: 0;
            z-index: 10;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .logo {
            color: var(--text-color);
            font-size: 1.4em;
            font-weight: 700;
        }
        #profile-btn, #notifications-btn, #theme-toggle-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
        }
        #profile-btn:hover, #notifications-btn:hover, #theme-toggle-btn:hover { color: var(--color-accent-blue); }
        
        #user-info-status {
             font-size: 0.8em;
             line-height: 1.3;
             text-align: right;
        }
        .status-inactive { color: var(--color-danger-red); } 
        .status-active { color: var(--color-accent-green); font-weight: bold; } 
        
        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .notification-indicator {
            position: relative;
        }
        .notification-indicator::after {
            content: attr(data-count);
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--color-danger-red);
            color: white;
            border-radius: 50%;
            padding: 1px 5px;
            font-size: 0.7em;
            font-weight: bold;
            display: none; 
        }
        .notification-indicator.active::after {
             display: inline-block;
        }

        /* OBSAHOVÁ OBLAST */
        #content-area {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto; 
            padding-bottom: 80px; 
        }
        .module { animation: fadeIn 0.5s; }
        .module.hidden { display: none; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1); } }

        h2 { color: var(--text-color); border-bottom: 1px solid var(--hr-color); padding-bottom: 10px; margin-bottom: 20px; font-weight: 500; font-size: 1.4em;}
        
        .primary-btn, .secondary-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            width: 100%; 
            box-sizing: border-box;
            margin-bottom: 10px;
            transition: background-color 0.2s, color 0.2s;
        }
        .primary-btn {
            background-color: var(--color-accent-blue);
            color: white;
            font-size: 1.1em;
            margin-top: 15px;
        }
        .secondary-btn {
            background-color: var(--input-border);
            color: var(--button-text-light); /* FIX Light Mode */
            margin-top: 15px;
        }
        .primary-btn:disabled, .secondary-btn:disabled {
             opacity: 0.5;
             cursor: not-allowed;
        }
        
        /* Formuláře */
        .auth-form-container {
             background-color: var(--content-bg);
             padding: 30px 20px;
             border-radius: 12px;
             margin-top: 30px;
             transition: background-color 0.3s;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            margin-bottom: 15px;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border);
            background-color: var(--input-bg);
            color: var(--text-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            margin-bottom: 15px;
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }
        
        /* NAVIGACE */
        #bottom-nav {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            background-color: var(--app-bg);
            border-top: 1px solid var(--hr-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 5px 0;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--nav-inactive);
            font-size: 0.75em;
            flex: 1;
            cursor: pointer;
            transition: color 0.3s;
        }
        .nav-item.active { color: var(--nav-active); }
        .nav-item.locked { opacity: 0.6; color: var(--color-danger-red); cursor: not-allowed; }
        .nav-item i { font-size: 1.5em; margin-bottom: 3px; }

        /* --- STYLY PRO KONFIGURACE (Identity, Scan) --- */
        .config-group {
             background-color: var(--content-bg);
             padding: 15px;
             border-radius: 10px;
             margin-bottom: 20px;
             transition: background-color 0.3s;
        }
        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--hr-color);
        }
        .config-item:last-child { border-bottom: none; }
        .item-info strong { display: block; color: var(--text-color); } /* FIX Light Mode */
        .item-info span { font-size: 0.8em; color: var(--text-muted); }
        .config-item:hover { background-color: rgba(128, 128, 128, 0.1); border-radius: 5px; padding: 10px; margin: -5px 0;}

        /* Toggle/Checkbox styly */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 45px;
            height: 25px;
        }
        .toggle-switch input { display: none; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--input-border); transition: 0.4s; border-radius: 25px;
        }
        .slider:before {
            position: absolute; content: ""; height: 19px; width: 19px; left: 3px; bottom: 3px;
            background-color: var(--text-color); transition: 0.4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--color-accent-green); }
        input:checked + .slider:before { transform: translateX(20px); }
        
        /* Historie */
        .activity-log-item {
            background-color: var(--input-bg);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .activity-log-item strong { color: var(--color-accent-blue); }
        
        /* Dashboard Cards */
        .dashboard-card {
            background-color: var(--content-bg);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            transition: background-color 0.3s;
        }
        .stat-widget {
             display: flex;
             justify-content: space-between;
             padding: 5px 0;
             font-size: 0.9em;
             color: var(--text-muted);
        }
        
        /* VPN */
        #vpn-status-header {
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--text-color);
        }
        #vpn-ip-display {
             color: var(--color-warning-yellow);
        }
        .item-row {
             display: flex;
             justify-content: space-between;
             padding: 5px 0;
             align-items: center;
             color: var(--text-color); /* FIX Light Mode */
        }
        
        /* Loading Bar (Simulace bez odpočtu) */
        .loading-bar {
            height: 15px;
            background-color: var(--input-border);
            border-radius: 8px;
            overflow: hidden;
            margin: 10px 0;
        }
        .loading-fill {
             height: 100%;
             width: 0%; 
             background-color: var(--color-accent-blue);
             animation: loading-animation 2s infinite linear; /* Pomalá a plynulá */
        }
        @keyframes loading-animation {
             0% { width: 10%; }
             50% { width: 90%; }
             100% { width: 10%; }
        }
        /* Loading pro Scan - Rychlejší, protože probíhá 10s (delší simulace) */
         .loading-fill.scan-fill {
             animation: loading-animation 1s infinite linear; 
         }

    </style>
</head>
<body>

    <div id="app-window" class="dark-mode">
        <header id="header">
             <h1 class="logo">Nexus Prime Security</h1>
             <div class="header-controls">
                 <button id="notifications-btn" class="notification-indicator" data-count="0" onclick="switchModule('notifications')">
                    <i class="fas fa-bell"></i>
                 </button>
                 <button id="theme-toggle-btn" onclick="handleThemeSwitch()">
                    <i class="fas fa-moon"></i>
                 </button>
                 <div id="user-info-status">
                     <span id="header-username">Odhlášeno</span><br>
                     <span id="header-license-status" class="status-inactive">Neaktivní</span>
                 </div>
                 <button id="profile-btn" onclick="switchModule('settings')">
                    <i class="fas fa-user-circle"></i>
                 </button>
             </div>
        </header>

        <main id="content-area">
            
            <div id="auth_select" class="module hidden">
                <h2>Vítejte v Nexus Prime</h2>
                <p style="color: var(--text-muted); margin-bottom: 20px;">Zabezpečte své mobilní zařízení. Pro přístup k ochraně se přihlaste nebo vytvořte nový účet.</p>
                <div class="auth-form-container">
                    <button id="show-login-btn" class="primary-btn">Přihlásit se k účtu</button>
                    <button id="show-register-btn" class="secondary-btn">Vytvořit Účet</button>
                </div>
            </div>

            <div id="login" class="module hidden">
                <h2><i class="fas fa-sign-in-alt"></i> Přihlášení k účtu</h2>
                <div class="auth-form-container">
                    <p id="login-message" style="margin-bottom: 20px; color: var(--text-muted);">Zadejte své uživatelské jméno a heslo:</p>
                    <div id="login-form">
                        <input type="text" id="login-username" placeholder="Uživatelské jméno">
                        <input type="password" id="login-password" placeholder="Heslo">
                        <button id="login-btn" class="primary-btn">Přihlásit se</button>
                        <button class="secondary-btn" onclick="switchModule('auth_select')">Zpět</button>
                    </div>
                </div>
            </div>
            
            <div id="register" class="module hidden">
                 <h2><i class="fas fa-user-plus"></i> Vytvoření Nového Účtu</h2>
                 <div class="auth-form-container">
                     <p style="margin-bottom: 20px;">Získejte přístup k funkcím Freemium verze.</p>
                     <div id="register-form">
                         <input type="text" id="reg-username" placeholder="Uživatelské jméno">
                         <input type="password" id="reg-password" placeholder="Heslo">
                         <button id="register-btn" class="primary-btn">Vytvořit Účet a Přihlásit se</button>
                         <button class="secondary-btn" onclick="switchModule('auth_select')">Zpět</button>
                     </div>
                 </div>
            </div>
            
            <div id="dashboard" class="module hidden">
                </div>
            
            <div id="paysafe" class="module hidden">
                <h2><i class="fas fa-credit-card"></i> Aktivace PRO Verze</h2>
                <div id="paysafe-payment-box" class="config-group">
                    </div>
            </div>
            
            <div id="scan" class="module hidden">
                <h2><i class="fas fa-rocket"></i> Chytrý Sken</h2>
                <div id="scan-content" class="premium-feature"></div>
            </div>
            
            <div id="vpn" class="module hidden">
                <h2><i class="fas fa-globe"></i> VPN Prime</h2>
                <div id="vpn-content" class="premium-feature"></div>
            </div>
            
            <div id="identity" class="module hidden">
                 <h2><i class="fas fa-user-shield"></i> Identity Guard</h2>
                <div id="identity-content" class="premium-feature">
                     </div>
            </div>
            
            <div id="settings" class="module hidden">
                <h2><i class="fas fa-cogs"></i> Profil a Historie</h2>
                <div id="settings-content" class="premium-feature">
                    </div>
            </div>
            
            <div id="notifications" class="module hidden">
                 <h2><i class="fas fa-bell"></i> Centrum Upozornění</h2>
                 <div id="notifications-list" class="config-group">
                     </div>
                 <button class="secondary-btn" id="clear-notifications-btn" onclick="clearNotifications()" disabled>Vymazat všechna upozornění</button>
            </div>
            
            <div id="optimization" class="module hidden">
                 <h2><i class="fas fa-tachometer-alt"></i> Optimalizace Výkonu</h2>
                 <div id="optimization-content" class="premium-feature"></div>
            </div>
            
            <div id="web_shield" class="module hidden">
                 <h2><i class="fas fa-shield-alt"></i> Web Shield & Anti-Phishing</h2>
                 <div id="web-shield-content" class="premium-feature"></div>
            </div>
            
            <div id="vault" class="module hidden">
                 <h2><i class="fas fa-lock"></i> Zabezpečený Trezor</h2>
                 <div id="vault-content" class="premium-feature"></div>
            </div>
            
            <div id="backup" class="module hidden">
                 <h2><i class="fas fa-cloud-upload-alt"></i> Cloudové Zálohování</h2>
                 <div id="backup-content" class="premium-feature"></div>
            </div>
            
             <div id="privacy" class="module hidden">
                 <h2><i class="fas fa-user-secret"></i> Ochrana Soukromí</h2>
                 <div id="privacy-content" class="premium-feature"></div>
            </div>
            
             <div id="payment_shield" class="module hidden">
                 <h2><i class="fas fa-money-check-alt"></i> Štít pro Platby</h2>
                 <div id="payment-shield-content" class="premium-feature">
                     <div class="dashboard-card">
                         <h3><i class="fas fa-shield-virus"></i> Ochrana Bankovních Aplikací</h3>
                         <p style="color: var(--text-muted);">Zajišťuje bezpečné prostředí pro bankovní a platební aplikace. **PRO aktivní**</p>
                         <div class="config-group">
                             <div class="config-item">
                                 <div class="item-info">
                                     <strong>Kontrola Wi-Fi připojení</strong>
                                     <span>Ověřuje zabezpečení sítě před spuštěním aplikace.</span>
                                 </div>
                                 <label class="toggle-switch"><input type="checkbox" checked><span class="slider round"></span></label>
                             </div>
                             <div class="config-item">
                                 <div class="item-info">
                                     <strong>Ochrana proti snímání obrazovky</strong>
                                     <span>Brání aplikacím třetích stran ve snímání obsahu.</span>
                                 </div>
                                 <label class="toggle-switch"><input type="checkbox" checked><span class="slider round"></span></label>
                             </div>
                         </div>
                         <button class="secondary-btn">Spravovat chráněné aplikace</button>
                     </div>
                 </div>
            </div>


        </main>
        
        <nav id="bottom-nav">
            <a href="#" class="nav-item active" data-module="dashboard" id="dashboard-nav">
                <i class="fas fa-home"></i> Home
            </a>
            <a href="#" class="nav-item locked" data-module="scan" id="scan-nav">
                <i class="fas fa-rocket"></i> Sken
            </a>
            <a href="#" class="nav-item locked" data-module="vpn" id="vpn-nav">
                <i class="fas fa-globe"></i> VPN
            </a>
            <a href="#" class="nav-item locked" data-module="identity" id="identity-nav">
                <i class="fas fa-user-shield"></i> Identity
            </a>
            <a href="#" class="nav-item locked" data-module="optimization" id="optimization-nav">
                <i class="fas fa-tachometer-alt"></i> Optimalizace
            </a>
            <a href="#" class="nav-item locked" data-module="web_shield" id="web_shield-nav">
                <i class="fas fa-shield-alt"></i> Web
            </a>
             <a href="#" class="nav-item locked" data-module="settings" id="settings-nav">
                <i class="fas fa-cogs"></i> Profil
            </a>
             <a href="#" class="nav-item locked" data-module="payment_shield" id="payment_shield-nav">
                <i class="fas fa-money-check-alt"></i> Platby
            </a>
        </nav>
    </div>

    <script>
        /* --- JAVASCRIPT LOGIKA V9.7 --- */
        const CURRENT_USER_KEY = 'nexusPrimeCurrentUser';
        const REGISTERED_USERS_KEY = 'nexusPrimeRegisteredUsers';
        const ACTIVITY_LOG_KEY = 'nexusPrimeActivityLog';
        const NOTIFICATIONS_KEY = 'nexusPrimeNotifications';
        
        // --- CENA A NOVÉ LICENCE (Upraveno dle požadavku: Bez 5% slevy, Bez doživotní) ---
        const SUBSCRIPTION_PLANS = {
            'half_year': { days: 182, fullPrice: 3999, discountedPrice: 3999, name: "Půl roku (3999 Kč)", pinConfig: [3610, 389] },
            'one_year': { days: 365, fullPrice: 7999, discountedPrice: 7999, name: "Jeden rok (7999 Kč)", pinConfig: [3610, 3610, 779] }
        };
        const DEFAULT_PRICE = SUBSCRIPTION_PLANS.one_year.discountedPrice;
        
        let currentUser = null;
        
        // --- DATA A JAZYKOVÉ PROMĚNNÉ ---
        
        const i18n = {
            "cs": {
                "welcome": "Vítejte zpět,", "paid_active": "PRO aktivní", "freemium_active": "Freemium", 
                "lock_title": "Tato funkce je uzamčena!", "lock_msg": "K odemčení je nutná **PRO licence**.",
                "status_active": "Aktivní PRO verze", "status_free": "Freemium (Základní ochrana)",
                "buy_pro": "Koupit PRO licenci", "logout": "Odhlásit se", "scan_run": "Spustit Sken",
                "scan_repair": "Opravit Vše (1 kliknutí)", "threats_found": "Nalezené hrozby:",
                "scan_status_ready": "Připraveno ke spuštění.", 
                "scan_status_running": "Skenování probíhá...", // NOVÝ TEXT
                "repair_done": "Oprava dokončena! Všechny hrozby byly odstraněny.", 
                "scan_done": "Skenování dokončeno! Nalezeno %s hrozeb.",
                "app_perm_scan": "Kontrola oprávnění aplikací", "app_perm_info": "Tyto aplikace mají oprávnění k přístupu k citlivým datům. Měli byste je zkontrolovat.",
                "app_perm_title": "Oprávnění aplikace", "app_perm_toggle": "Omezit přístup",
                "app_perm_toggle_on": "Povolit", "app_perm_toggle_off": "Omezit",
                "vault_title": "Simulovaný Trezor", "vault_desc": "Bezpečně uložte přihlašovací údaje a dokumenty."
            }
        };

        const SIMULATION_DATA = {
            // Idea 1/23 - Podrobné hrozby
            SIMULATED_THREATS: [
                 { name: "Cookie_ID: 45A-87Z", type: "Tracking", location: "/data/user/cache/chrome" },
                 { name: "Nezabezpečený WiFi Port (8080)", type: "Network Vulnerability", location: "Router Settings" },
                 { name: "Zastaralý systémový patch (Kernel)", type: "System Vulnerability", location: "System Core" },
                 { name: "FakeSystemUpdater.apk", type: "Malware/PUP", location: "/storage/downloads" },
                 { name: "Narušení: Primary email", type: "Identity Breach", location: "Dark Web Report" }
            ],
            // NOVÉ: Loading texty pro simulaci
            SCAN_LOADING_MESSAGES: [
                 "Inicializace jádra a ThreatLab API...",
                 "Analýza systémových registrů: Klíč B2D-7X...",
                 "Hloubková kontrola souborového systému (1/3)...",
                 "Verifikace integrity aplikací třetích stran...",
                 "Skript: C-1457 - Kontrola potenciálně nebezpečných programů (PUP)...",
                 "Kontrola oprávnění a sítě (DNS Hijacking)...",
                 "Kompletní analýza: Zpracování výsledků...",
                 "Generování souhrnné zprávy... (Finální fáze)"
            ],
            // Idea 11/26 - Oprávnění aplikací
            APP_PERMISSIONS: [
                 { name: "Facebook", type: "Social", permissions: ["Poloha", "Mikrofon", "Kontakty"], restricted: false },
                 { name: "Bankovní App", type: "Finance", permissions: ["Síť", "Stav telefonu"], restricted: false },
                 { name: "Hra XYZ", type: "Game", permissions: ["Kontakty", "Galerie"], restricted: false },
                 { name: "Kamera", type: "System", permissions: ["Poloha", "Mikrofon", "Galerie"], restricted: false },
                 { name: "Simulovaná Špehovací App", type: "Malware", permissions: ["Poloha", "Mikrofon", "Síť", "Galerie"], restricted: false }
            ],
            // Idea 6 - VPN Protokoly
            VPN_PROTOCOLS: ["WireGuard (Doporučeno)", "OpenVPN", "IKEv2"],
            // Idea 13 - Technické detaily
            SYSTEM_INFO: {
                KERNEL_VERSION: "5.15.0-94-generic",
                PATCH_DATE: new Date('2025-11-01'), // Simulace starého patche
                LAST_IP: "192.168.1.100",
                QUARANTINE_CODE: "E3C4-F9D2-A1B7"
            },
            // Idea 8 - HW widgety
            HW_STATS: {
                 RAM: { total: 8000, used: 5200 },
                 BATTERY: { health: 98, temp: 35.5 }
            },
            IDENTITY_ITEMS: [
                { name: "Primární e-mail", type: "email", defaultChecked: true },
                { name: "Záložní e-mail", type: "email", defaultChecked: false },
                { name: "Číslo kreditní karty (4 cifry)", type: "card", defaultChecked: true },
                { name: "Rodné číslo", type: "social", defaultChecked: true },
                { name: "Telefonní číslo", type: "phone", defaultChecked: true },
                { name: "Uživatelské jmé (sociální sítě)", type: "username", defaultChecked: true },
            ],
            SCAN_AREAS: [
                { name: "Systémové soubory (jádro OS)", default: true },
                { name: "Aplikace třetích stran", default: true },
                { name: "Registry a databáze", default: true },
                { name: "Simulované Adware skripty", default: true },
                { name: "Potenciálně nežádoucí programy (PUP)", default: true },
            ],
            VPN_SERVERS: [
                "Automaticky (Nejrychlejší)", "Česká republika (Praha 1)", "Německo (Frankfurt)", 
                "USA (New York)", "Japonsko (Tokio)", "Singapur"
            ],
            // NOVÉ: Plánování Skenu
            SCAN_SCHEDULES: ["Vypnuto", "Týdně (Neděle 2:00)", "Denně (23:00)"],
            
        };

        let currentLang = 'cs';
        const _ = (key) => i18n[currentLang][key] || key;
        
        // --- NOVÉ GLOBÁLNÍ STAVY ---
        let vpnInterval = null;
        let isVpnConnected = false;
        let simulatedThreats = [];
        let selectedPlan = 'one_year'; // Defaultní plán pro platbu
        
        // --- ČASY SIMULACE (5-10 minut) ---
        const SIMULATION_DURATION_LONG = 10000; // 10 sekund (pro sken, identitu, zálohu)
        const SIMULATION_DURATION_SHORT = 5000; // 5 sekund (pro optimalizaci, VPN, web shield)
        
        // --- FUNKCE PRO VÝPOČET A TRVALOST DAT ---
        const calculateExpirationDate = (planKey) => {
            const plan = SUBSCRIPTION_PLANS[planKey];
            if (!plan) return null;
            
            const today = new Date();
            today.setDate(today.getDate() + plan.days);
            return today.toLocaleDateString('cs-CZ');
        };
        
        const calculateSimulatedIP = (serverName) => {
             const parts = serverName.match(/\((.*?)\)/);
             let base = '104.28.';
             if (parts && parts[1].includes('Praha')) base = '85.15.';
             if (parts && parts[1].includes('New York')) base = '23.227.';
             
             // Generuje náhodné poslední dva bloky
             const randomPart = Math.floor(Math.random() * 255) + '.' + Math.floor(Math.random() * 255);
             return base + randomPart;
        };
        
        const getRegisteredUsers = () => { return JSON.parse(localStorage.getItem(REGISTERED_USERS_KEY)) || {}; };
        const saveRegisteredUsers = (users) => { localStorage.setItem(REGISTERED_USERS_KEY, JSON.stringify(users)); };
        const saveCurrentUserState = () => { if (currentUser) localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(currentUser)); };
        
        // Kontrola Expirace a downgrade
        const checkLicenseExpiration = (user) => {
            if (user.isPaid && user.license_expiration_date) {
                const parts = user.license_expiration_date.split('.');
                // Převod z DD. MM. RRRR na RRRR-MM-DD pro správnou konstrukci Data
                if (parts.length === 3) {
                    const expiry = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); 
                    
                    if (expiry < today) {
                        user.isPaid = false;
                        user.remainingAmount = SUBSCRIPTION_PLANS[user.last_plan_key || 'one_year'].fullPrice; // Získat plnou cenu
                        user.license_expiration_date = null;
                        user.license_key = null; // Odstranění klíče
                        logActivity(`VAROVÁNÍ: PRO licence vypršela. Přepnuto na Freemium.`, 'var(--color-danger-red)');
                        return false; 
                    }
                }
            }
            return user.isPaid; 
        };

        const loadCurrentUserState = () => { 
             const stored = localStorage.getItem(CURRENT_USER_KEY);
             if (stored) {
                 let storedUser = JSON.parse(stored);
                 const users = getRegisteredUsers();
                 const fullUser = users[storedUser.username] || storedUser;
                 
                 currentUser = {
                     username: fullUser.username,
                     password: fullUser.password,
                     isPaid: fullUser.isPaid || false,
                     remainingAmount: fullUser.remainingAmount || DEFAULT_PRICE,
                     pinIndex: fullUser.pinIndex || 0,
                     license_expiration_date: fullUser.license_expiration_date || null,
                     currentTheme: fullUser.currentTheme || 'dark',
                     vpnIp: fullUser.vpnIp || SIMULATION_DATA.SYSTEM_INFO.LAST_IP,
                     hasBreach: fullUser.hasBreach || false,
                     threatsFound: fullUser.threatsFound || (fullUser.isPaid ? 0 : 5),
                     license_key: fullUser.license_key || null, 
                     scan_schedule: fullUser.scan_schedule || 'Vypnuto',
                     last_plan_key: fullUser.last_plan_key || 'one_year' // Nové: Klíč posledního plánu
                     
                 };
                 
                 checkLicenseExpiration(currentUser);
                 saveCurrentUserState();
                 return true;
             }
             return false;
        };
        
        const switchModule = (moduleId) => {
            if (!currentUser && moduleId !== 'auth_select' && moduleId !== 'login' && moduleId !== 'register') {
                alert(_('Must_login')); 
                moduleId = 'auth_select';
            }
            // Zamykání PRO modulů při Freemium
            const isPro = currentUser ? currentUser.isPaid : false;
            // Přidán payment_shield
            const proModules = ['scan', 'vpn', 'identity', 'optimization', 'web_shield', 'vault', 'privacy', 'backup', 'payment_shield'];
            if (!isPro && proModules.includes(moduleId) && moduleId !== 'settings') {
                 alert(`${_('lock_title')} ${_('lock_msg')}`);
                 return;
            }

            document.querySelectorAll('.module').forEach(m => m.classList.add('hidden'));
            document.getElementById(moduleId).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            const activeNav = document.querySelector(`.nav-item[data-module="${moduleId}"]`) || document.getElementById('dashboard-nav');
            if (activeNav) activeNav.classList.add('active');
            
            // Speciální funkce pro nové moduly
            if (moduleId === 'paysafe') setPaysafeModuleContent();
            if (moduleId === 'optimization') document.getElementById('optimization-content').innerHTML = generateOptimizationHtml();
            if (moduleId === 'web_shield') document.getElementById('web-shield-content').innerHTML = generateWebShieldHtml();
            if (moduleId === 'vault') document.getElementById('vault-content').innerHTML = generateVaultHtml();
            if (moduleId === 'backup') document.getElementById('backup-content').innerHTML = generateBackupHtml();
            if (moduleId === 'privacy') document.getElementById('privacy-content').innerHTML = generatePrivacyHtml();
            if (moduleId === 'settings') document.getElementById('settings-content').innerHTML = generateSettingsHtml();
            if (moduleId === 'notifications') displayNotifications();
            if (moduleId === 'scan') document.getElementById('scan-content').innerHTML = generateScanHtml();
            if (moduleId === 'vpn') document.getElementById('vpn-content').innerHTML = generateVpnHtml();
             if (moduleId === 'identity') document.getElementById('identity-content').innerHTML = generateIdentityGuardHtml();
        };

        // --- REALISTICKÝ LOG AKTIVIT ---
        const logActivity = (description, color = 'var(--text-color)', isNotification = false) => { // FIX barva defaultně na var(--text-color)
            if (!currentUser) return;
            const logEntry = {
                timestamp: new Date().toLocaleDateString('cs-CZ') + ' ' + new Date().toLocaleTimeString('cs-CZ'),
                description: description,
                color: color
            };
            
            let logs = JSON.parse(localStorage.getItem(ACTIVITY_LOG_KEY)) || [];
            logs.unshift(logEntry); 
            localStorage.setItem(ACTIVITY_LOG_KEY, JSON.stringify(logs.slice(0, 50)));
            
            // Notifikace pouze pro explicitně označené nebo kritické události
            if (isNotification || color === 'var(--color-danger-red)') {
                addNotification(description);
            }
        };

        // --- NOTIFIKACE (Vypnuto pro běžné logy) ---
        const getNotifications = () => { return JSON.parse(localStorage.getItem(NOTIFICATIONS_KEY)) || []; };
        const saveNotifications = (notes) => { localStorage.setItem(NOTIFICATIONS_KEY, JSON.stringify(notes)); };
        
        const addNotification = (message) => {
             let notes = getNotifications();
             const newNote = {
                 message: message,
                 timestamp: new Date().toLocaleTimeString('cs-CZ'),
                 read: false
             };
             notes.unshift(newNote);
             saveNotifications(notes);
             updateNotificationUI();
        };
        
        const updateNotificationUI = () => {
             let notes = getNotifications();
             const unreadCount = notes.filter(n => !n.read).length;
             const indicator = document.getElementById('notifications-btn');
             indicator.setAttribute('data-count', unreadCount);
             
             if (unreadCount > 0) {
                 indicator.classList.add('active');
                 indicator.style.color = 'var(--color-danger-red)';
             } else {
                 indicator.classList.remove('active');
                 indicator.style.color = 'var(--text-color)';
             }
        };
        
        const displayNotifications = () => {
            let notes = getNotifications();
            const listElement = document.getElementById('notifications-list');
            const clearBtn = document.getElementById('clear-notifications-btn');
            
            if (notes.length === 0) {
                 listElement.innerHTML = `<p style="color: var(--text-muted);">Žádná nová upozornění.</p>`;
                 clearBtn.disabled = true;
                 return;
            }
            
            listElement.innerHTML = notes.map(note => `
                <div class="activity-log-item" style="border: 1px solid ${note.read ? 'transparent' : 'var(--color-danger-red)'}; opacity: ${note.read ? 0.7 : 1};">
                    <p style="margin: 0;">${note.message}</p>
                    <span style="font-size: 0.7em; color: var(--text-muted);">${note.timestamp}</span>
                </div>
            `).join('');
            
            // Označit jako přečtené při zobrazení
            notes = notes.map(n => ({ ...n, read: true }));
            saveNotifications(notes);
            updateNotificationUI();
            clearBtn.disabled = false;
        };

        const clearNotifications = () => {
             saveNotifications([]);
             displayNotifications();
             logActivity("Upozornění vymazána z Centra Notifikací.", 'var(--text-color)', true);
        };

        // --- AUTENTIZACE ---
        const handleRegister = () => { 
             const regUsername = document.getElementById('reg-username').value.trim();
             const regPassword = document.getElementById('reg-password').value.trim();
             const users = getRegisteredUsers();

             if (regUsername.length < 3 || regPassword.length < 5) {
                 alert('Prosím, zadejte platné uživatelské jméno (min 3 znaky) a heslo (min 5 znaků).');
                 return;
             }
             if (users[regUsername] || (regUsername === 'Vašek')) {
                  alert(`Uživatelské jméno "${regUsername}" je již obsazeno.`);
                  return;
             }
             
             // Nastavení nových polí
             const newUser = { 
                 username: regUsername, 
                 password: regPassword, 
                 isPaid: false, 
                 remainingAmount: DEFAULT_PRICE, 
                 pinIndex: 0, 
                 license_expiration_date: null,
                 currentTheme: 'dark',
                 vpnIp: SIMULATION_DATA.SYSTEM_INFO.LAST_IP,
                 hasBreach: false,
                 threatsFound: 5,
                 license_key: null,
                 scan_schedule: 'Vypnuto',
                 last_plan_key: 'one_year'
             };
             users[regUsername] = newUser;
             saveRegisteredUsers(users);
             currentUser = newUser;
             saveCurrentUserState();
             logActivity(`Registrace nového účtu: ${regUsername}.`, 'var(--text-color)', true);
             unlockFeaturesUI('Freemium', `${_('welcome')} ${regUsername}! Váš účet byl vytvořen.`, 'dashboard');
        };
        
        const generateLicenseKey = () => {
             // Generuje fiktivní 5x5 licenční klíč
             const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
             let key = '';
             for (let i = 0; i < 5; i++) {
                 for (let j = 0; j < 5; j++) {
                     key += chars.charAt(Math.floor(Math.random() * chars.length));
                 }
                 if (i < 4) key += '-';
             }
             return key;
        };

        const handleLogin = () => { 
             const loginUsername = document.getElementById('login-username').value.trim();
             const loginPassword = document.getElementById('login-password').value.trim();
             const users = getRegisteredUsers();
             
             // Speciální účet pro testování PRO verze
             if (loginUsername === 'Vašek' && loginPassword === 'vasek11') {
                  const existingVašek = users['Vašek'];
                  let expirationDate = existingVašek ? existingVašek.license_expiration_date : null;
                  
                  // Použijeme roční licenci pro testovacího uživatele
                  if (!expirationDate || checkLicenseExpiration({ isPaid: true, license_expiration_date: expirationDate })) {
                       expirationDate = calculateExpirationDate('one_year');
                  }
                  
                  const licenseKey = existingVašek && existingVašek.license_key ? existingVašek.license_key : generateLicenseKey();

                  currentUser = { 
                      username: 'Vašek', 
                      password: 'vasek11', 
                      isPaid: true, 
                      remainingAmount: 0, 
                      pinIndex: SUBSCRIPTION_PLANS.one_year.pinConfig.length, // Plně placeno
                      license_expiration_date: expirationDate,
                      currentTheme: existingVašek ? existingVašek.currentTheme : 'dark',
                      vpnIp: SIMULATION_DATA.SYSTEM_INFO.LAST_IP,
                      hasBreach: false,
                      threatsFound: 0,
                      license_key: licenseKey,
                      scan_schedule: existingVašek ? existingVašek.scan_schedule : 'Týdně (Neděle 2:00)',
                      last_plan_key: 'one_year'
                  };
                  
                  users['Vašek'] = currentUser;
                  saveRegisteredUsers(users);
                  saveCurrentUserState();
                  logActivity(`Přihlášení uživatele Vašek (PRO licence - Testovací).`, 'var(--text-color)', true);
                  unlockFeaturesUI('PRO', `${_('welcome')} ${currentUser.username}! PRO verze je automaticky aktivována.`, 'dashboard');
                  return;
             }

             const storedUser = users[loginUsername];
             if (storedUser && storedUser.password === loginPassword) {
                  currentUser = storedUser;
                  
                  const wasPaid = currentUser.isPaid;
                  checkLicenseExpiration(currentUser);
                  
                  saveCurrentUserState();
                  const licenseType = currentUser.isPaid ? 'PRO' : 'Freemium';
                  const message = (wasPaid && !currentUser.isPaid) ? `Licence vypršela. ${_('welcome')} ${currentUser.username}!` : `${_('welcome')} ${currentUser.username}!`;
                  
                  logActivity(`Úspěšné přihlášení uživatele ${currentUser.username}.`, 'var(--text-color)');
                  unlockFeaturesUI(licenseType, message, 'dashboard');
                  return;
             }

             document.getElementById('login-message').innerText = 'Chyba: Neplatné uživatelské jméno nebo heslo.';
             document.getElementById('login-message').style.color = 'var(--color-danger-red)';
        };
        
        const handleLogout = () => { 
             logActivity(`Odhlášení uživatele ${currentUser.username}.`, 'var(--text-color)', true);
             currentUser = null;
             isVpnConnected = false;
             if(vpnInterval) clearInterval(vpnInterval);
             localStorage.removeItem(CURRENT_USER_KEY);
             localStorage.removeItem(NOTIFICATIONS_KEY); 
             
             document.getElementById('header-username').innerText = 'Odhlášeno';
             document.getElementById('header-license-status').innerText = 'Neaktivní';
             document.getElementById('header-license-status').className = 'status-inactive';
             document.getElementById('app-window').className = 'dark-mode'; 
             document.querySelectorAll('.nav-item').forEach(nav => {
                 nav.classList.add('locked'); nav.querySelector('i').className = 'fas fa-lock'; // Opravená ikona zámku
             });
             document.getElementById('dashboard').innerHTML = '';
             updateNotificationUI();
             switchModule('auth_select');
        };

        // --- PLATEBNÍ MODUL LOGIKA (Upraveno dle požadavku) ---
         const updateRemainingDisplay = () => {
             const remainingAmountSpan = document.getElementById('remaining-amount');
             const currentPlanKey = document.getElementById('plan-select').value;
             const plan = SUBSCRIPTION_PLANS[currentPlanKey];
             
             // Nastavení stavu pro nový plán
             if (currentUser.last_plan_key !== currentPlanKey) {
                 currentUser.last_plan_key = currentPlanKey;
                 currentUser.remainingAmount = plan.fullPrice;
                 currentUser.pinIndex = 0;
             }
             
             if (!remainingAmountSpan || !currentUser) return;
             
             remainingAmountSpan.innerText = currentUser.remainingAmount.toLocaleString('cs-CZ') + ' Kč';
             selectedPlan = currentPlanKey;
             
             const submitPinBtn = document.getElementById('submit-pin-btn');
             const paysafePinInput = document.getElementById('paysafe-pin-input');
             
             // Pokud je placení kompletní
             if (currentUser.remainingAmount <= 0) {
                 const expirationDate = calculateExpirationDate(selectedPlan);
                 const licenseKey = generateLicenseKey();

                 currentUser.isPaid = true;
                 currentUser.license_expiration_date = expirationDate;
                 currentUser.threatsFound = 0;
                 currentUser.license_key = licenseKey;
                 
                 const users = getRegisteredUsers();
                 if (users[currentUser.username]) {
                    users[currentUser.username].isPaid = true;
                    users[currentUser.username].remainingAmount = 0;
                    users[currentUser.username].license_expiration_date = expirationDate; 
                    users[currentUser.username].threatsFound = 0;
                    users[currentUser.username].license_key = licenseKey;
                    users[currentUser.username].pinIndex = SUBSCRIPTION_PLANS[selectedPlan].pinConfig.length;
                    saveRegisteredUsers(users);
                 }
                 saveCurrentUserState();
                 logActivity(`Aktivace PRO licence (${plan.name}) dokončena. Platnost do ${expirationDate}.`, 'var(--color-accent-green)', true);

                 const paysafeBox = document.getElementById('paysafe-payment-box');
                 paysafeBox.innerHTML = `
                    <h3 style="color: var(--color-accent-green);"><i class="fas fa-check-circle"></i> Platba dokončena!</h3>
                    <p>Licence **Nexus PRO** na **${plan.name}** byla úspěšně aktivována s platností do **${expirationDate}**.</p>
                    <button class="primary-btn" onclick="unlockFeaturesUI('PRO', 'Gratulujeme! PRO verze je aktivní.', 'dashboard')">Pokračovat na Dashboard</button>
                 `;
             } else {
                 if (submitPinBtn) submitPinBtn.disabled = false;
                 if (paysafePinInput) {
                     paysafePinInput.disabled = false;
                     paysafePinInput.placeholder = `Zadejte ${currentUser.pinIndex + 1}. PIN Paysafecard`;
                 }
             }
         };
         
         const addLog = (message, color) => {
             const transactionLog = document.getElementById('transaction-log');
             if (!transactionLog) return;
             const p = document.createElement('p');
             p.innerHTML = `<span style="color: ${color};">• ${message}</span>`;
             transactionLog.insertBefore(p, transactionLog.children[1]); 
             transactionLog.scrollTop = 0;
         };
         
         const handlePaysafePinSubmit = () => {
             const paysafePinInput = document.getElementById('paysafe-pin-input');
             const submitPinBtn = document.getElementById('submit-pin-btn');
             const pin = paysafePinInput.value.trim();
             const currentPlan = SUBSCRIPTION_PLANS[currentUser.last_plan_key];
             
             if (pin.length !== 16 || !/^\d+$/.test(pin)) {
                 addLog("Chyba: PIN musí být 16místné číslo.", "var(--color-danger-red)");
                 return;
             }
             
             if (currentUser.pinIndex >= currentPlan.pinConfig.length || currentUser.remainingAmount <= 0) {
                  addLog("Platba je již dokončena. PIN ignorován.", "var(--color-accent-green)");
                  return;
             }

             submitPinBtn.disabled = true;
             paysafePinInput.disabled = true;
             addLog(`Ověřování PINu ${pin}...`, "var(--color-warning-yellow)");
             logActivity(`Pokus o zadání PINu Paysafecard (PIN #${currentUser.pinIndex + 1}).`);
             
             setTimeout(() => {
                 let pinValue = currentPlan.pinConfig[currentUser.pinIndex]; 
                 
                 const amountPaid = Math.min(pinValue, currentUser.remainingAmount);
                 const refund = pinValue - amountPaid;

                 if (currentUser.remainingAmount > 0) {
                     currentUser.remainingAmount -= amountPaid;
                     currentUser.pinIndex++;
                     
                     addLog(`PIN #${currentUser.pinIndex} (hodnota ${pinValue.toLocaleString('cs-CZ')} Kč) ověřen! Použito: ${amountPaid.toLocaleString('cs-CZ')} Kč.`, "var(--color-accent-green)");
                     logActivity(`Platba přijata: ${amountPaid.toLocaleString('cs-CZ')} Kč.`);
                     if (refund > 0) {
                          addLog(`Přeplatek (${refund.toLocaleString('cs-CZ')} Kč) zůstává na PINu.`, "var(--color-warning-yellow)");
                     }
                 } 
                 
                 updateRemainingDisplay();
                 paysafePinInput.value = '';
                 
                 if (currentUser.remainingAmount > 0) {
                     submitPinBtn.disabled = false;
                     paysafePinInput.disabled = false;
                 }
                 saveCurrentUserState(); 

             }, 2500); 
         };
        
        const setPaysafeModuleContent = () => {
             const paysafeBox = document.getElementById('paysafe-payment-box');
             
             if (currentUser && currentUser.isPaid) {
                 paysafeBox.innerHTML = `
                    <h3 style="color: var(--color-accent-green);"><i class="fas fa-check-circle"></i> PRO licence je aktivní.</h3>
                    <p>Platnost do: <strong>${currentUser.license_expiration_date || 'Neznámé datum'}</strong>.</p>
                    <h4 style="margin-top: 20px;"><i class="fas fa-file-invoice"></i> Správa Předplatného</h4>
                    <p>Licenční Klíč: <strong>${currentUser.license_key || 'Není definován'}</strong></p>
                    <p>Zaplaceno PINy: **${currentUser.pinIndex} / ${SUBSCRIPTION_PLANS[currentUser.last_plan_key].pinConfig.length}**</p>
                 `;
                 return;
             }
             
             const planOptions = Object.keys(SUBSCRIPTION_PLANS).map(key => {
                 const plan = SUBSCRIPTION_PLANS[key];
                 return `<option value="${key}" ${key === currentUser.last_plan_key ? 'selected' : ''}>
                            ${plan.name}
                         </option>`;
             }).join('');


             paysafeBox.innerHTML = `
                <h4>Vybrat Předplatné (Bez slev)</h4>
                <div class="form-group">
                    <select id="plan-select" onchange="updateRemainingDisplay()">
                        ${planOptions}
                    </select>
                </div>
                <div id="paysafe-status-bar" style="padding: 15px; background-color: var(--input-bg); border-radius: 8px; font-size: 1.2em; font-weight: bold; margin-bottom: 20px; transition: background-color 0.3s;">
                    Zbývající částka k úhradě: <span id="remaining-amount" class="text-remaining">${DEFAULT_PRICE.toLocaleString('cs-CZ')} Kč</span>
                </div>
                <div class="paysafe-input-area">
                    <input type="text" id="paysafe-pin-input" placeholder="Zadejte 1. PIN Paysafecard" maxlength="16">
                    <button id="submit-pin-btn" class="primary-btn">Ověřit PIN</button>
                </div>
                <div id="transaction-log"><p>Log transakcí:</p></div>
                <button class="secondary-btn" onclick="switchModule('dashboard')">Zpět na Dashboard</button>
             `;
             
             document.getElementById('submit-pin-btn').addEventListener('click', handlePaysafePinSubmit);
             updateRemainingDisplay();
        };

        // --- DASHBOARD (Vylepšený) ---
        const calculateSecurityScore = (isPro, threats) => {
             let score = isPro ? 100 : 65;
             if (threats > 0) {
                 score -= (threats * 10);
             }
             if (!isPro && currentUser.threatsFound > 0) score = 65; 
             if (SIMULATION_DATA.SYSTEM_INFO.PATCH_DATE < new Date(new Date().setDate(new Date().getDate() - 30))) { 
                 score -= 5;
             }
             return Math.max(50, score) + '%';
        };

        const setDashboardContent = (licenseType) => {
             const isPro = licenseType === 'PRO';
             const color = currentUser.threatsFound > 0 ? 'var(--color-danger-red)' : isPro ? 'var(--color-accent-green)' : 'var(--color-danger-red)';
             const statusText = currentUser.threatsFound > 0 ? 'NEBEZPEČÍ! Zjištěno narušení.' : isPro ? 'Optimální zabezpečení PRO!' : 'Vyžaduje okamžitou akci!';
             const score = calculateSecurityScore(isPro, currentUser.threatsFound);
             const buttonText = isPro ? `${_('scan_run')}` : `${_('buy_pro')}`;
             
             const dashboardModule = document.getElementById('dashboard');
             
             const licenseDetail = isPro 
                ? `
                    <p>Stav licence: <span style="color: ${color};">${_('status_active')}</span></p>
                    <p>Platnost do: <strong>${currentUser.license_expiration_date || 'Neznámé datum'}</strong></p>
                  ` 
                : `
                    <p>Stav licence: <span style="color: ${color};">${_('status_free')}</span></p>
                  `;
                  
            const ramUsed = SIMULATION_DATA.HW_STATS.RAM.used;
            const ramTotal = SIMULATION_DATA.HW_STATS.RAM.total;
            const batteryTemp = SIMULATION_DATA.HW_STATS.BATTERY.temp;
            
            const recommendation = currentUser.threatsFound > 0 ? 
                 `<p style="color: var(--color-danger-red); font-weight: bold; margin-top: 10px;">DOPORUČENÍ: Okamžitě spusťte "Opravit Vše" ve Skenu!</p>` :
                 isPro ? 
                 `<p style="color: var(--color-accent-blue); margin-top: 10px;">DOPORUČENÍ: Zkontrolujte stav Identity Guard.</p>` :
                 `<p style="color: var(--color-warning-yellow); margin-top: 10px;">DOPORUČENÍ: Kupte PRO verzi pro 100% ochranu!</p>`;
             
             const updateNeeded = SIMULATION_DATA.SYSTEM_INFO.PATCH_DATE < new Date(new Date().setDate(new Date().getDate() - 30));

             dashboardModule.innerHTML = `
                <h2><i class="fas fa-home"></i> Domovská Obrazovka</h2>
                <div id="security-score-card" class="dashboard-card" style="border: 1px solid ${color}; text-align: center;">
                    <div id="score-gauge" style="border-radius: 50%; border: 8px solid ${color}; display: flex; align-items: center; justify-content: center; width: 120px; height: 120px; font-size: 2em; margin: 0 auto; color: ${color};">${score}</div>
                    <h3 style="margin-top: 15px;">Stav Systému</h3>
                    <p id="system-status-text" style="color: ${color}; font-size: 1.1em; font-weight: bold;">${statusText}</p>
                    ${recommendation}
                    <button id="start-smart-scan-dashboard" class="primary-btn" style="background-color: ${currentUser.threatsFound > 0 ? 'var(--color-danger-red)' : 'var(--color-accent-blue)'};">${buttonText}</button>
                </div>
                
                <h3 style="margin-top: 20px; font-weight: 500;"><i class="fas fa-desktop"></i> Živé Statistiky</h3>
                <div class="dashboard-card">
                    <div class="stat-widget">
                         <span>RAM Využití:</span>
                         <span style="color: var(--color-accent-green);">${ramUsed}MB / ${ramTotal}MB (${((ramUsed / ramTotal) * 100).toFixed(0)}%)</span>
                    </div>
                    <div class="stat-widget">
                         <span>Teplota Baterie:</span>
                         <span style="color: var(--color-accent-green);">${batteryTemp}°C</span>
                    </div>
                    <div class="stat-widget">
                         <span>Status Kernelu:</span>
                         <span style="color: ${updateNeeded ? 'var(--color-danger-red)' : 'var(--color-accent-green)'};">${updateNeeded ? 'Zastaralý!' : 'Aktuální'}</span>
                    </div>
                </div>
                
                <h3 style="margin-top: 20px; font-weight: 500;"><i class="fas fa-user-circle"></i> Přehled Účtu</h3>
                <div class="dashboard-card">
                    <p>Uživatel: <strong>${currentUser.username}</strong></p>
                    ${licenseDetail}
                    <p>Aktuální IP: <strong style="color: var(--color-warning-yellow);">${isVpnConnected ? currentUser.vpnIp : SIMULATION_DATA.SYSTEM_INFO.LAST_IP}</strong></p>
                    <button class="secondary-btn" onclick="handleLogout()">${_('logout')}</button>
                </div>
             `;
             
             const scanBtn = document.getElementById('start-smart-scan-dashboard');
             if (scanBtn) {
                 if (isPro) {
                     scanBtn.addEventListener('click', () => {
                         switchModule('scan');
                         logActivity(`Spuštěn Chytrý Sken z Dashboardu.`);
                     });
                 } else {
                     scanBtn.addEventListener('click', () => switchModule('paysafe'));
                 }
             }
             
             const header = document.getElementById('header');
             if (currentUser.threatsFound > 0) {
                 header.style.backgroundColor = 'rgba(220, 53, 69, 0.4)'; 
             } else {
                 header.style.backgroundColor = 'var(--app-bg)'; 
             }
        };


        // --- VPN (Simulace 5 minut) ---
        const generateVpnHtml = () => {
             const options = SIMULATION_DATA.VPN_SERVERS.map(server => 
                 `<option value="${server.replace(/\s/g, '-')}" ${server.includes('Automaticky') ? 'selected' : ''}>${server}</option>`
             ).join('');
             
             const protocols = SIMULATION_DATA.VPN_PROTOCOLS.map(protocol => 
                 `<option value="${protocol}" ${protocol.includes('WireGuard') ? 'selected' : ''}>${protocol}</option>`
             ).join('');

             const statusContent = isVpnConnected 
                 ? `<div style="padding: 10px; background-color: var(--content-bg); border-radius: 8px;">
                        <h3 id="vpn-status-header" style="color: var(--color-accent-green);"><i class="fas fa-check-circle"></i> Stav: Připojeno</h3>
                        <p id="vpn-ip-display">IP Adresa: ${currentUser.vpnIp}</p>
                    </div>`
                 : `<div style="padding: 10px; background-color: var(--content-bg); border-radius: 8px;">
                        <h3 id="vpn-status-header" style="color: var(--color-danger-red);"><i class="fas fa-power-off"></i> Stav: Odpojeno</h3>
                        <p id="vpn-ip-display">Vaše IP: ${SIMULATION_DATA.SYSTEM_INFO.LAST_IP}</p>
                    </div>`;

             return `
                <div class="dashboard-card" id="vpn-status-card">
                    ${statusContent}
                </div>
                
                <h3 style="margin-top: 20px;">Nastavení Připojení</h3>
                <div class="config-group">
                    <div class="server-list">
                        <label for="vpn-protocol-select" style="display: block; margin-bottom: 5px;">Vybrat Protokol:</label>
                        <select id="vpn-protocol-select" ${isVpnConnected ? 'disabled' : ''}>
                            ${protocols}
                        </select>
                    </div>
                    <div class="server-list">
                        <label for="vpn-server-select" style="display: block; margin-bottom: 5px;">Vybrat Server (Geolokace):</label>
                        <select id="vpn-server-select" ${isVpnConnected ? 'disabled' : ''}>
                            ${options}
                        </select>
                    </div>
                </div>
                <button class="primary-btn" id="vpn-toggle" onclick="simulateVpnConnection(this)">${isVpnConnected ? 'Odpojit' : 'Připojit'}</button>
             `;
        };
        
        const simulateVpnConnection = (vpnToggleBtn) => {
             const selectedServer = document.getElementById('vpn-server-select').value.replace(/-/g, ' ');
             const selectedProtocol = document.getElementById('vpn-protocol-select').value;
             const vpnStatusCard = document.getElementById('vpn-status-card');
             
             if (isVpnConnected) {
                isVpnConnected = false;
                if(vpnInterval) clearInterval(vpnInterval);
                logActivity(`Odpojeno od VPN serveru: ${selectedServer}.`, 'var(--text-color)');
                
                vpnStatusCard.innerHTML = `<div style="padding: 10px; background-color: var(--content-bg); border-radius: 8px;">
                        <h3 id="vpn-status-header" style="color: var(--color-danger-red);"><i class="fas fa-power-off"></i> Stav: Odpojeno</h3>
                        <p id="vpn-ip-display">Vaše IP: ${SIMULATION_DATA.SYSTEM_INFO.LAST_IP}</p>
                    </div>`;
                vpnToggleBtn.innerText = 'Připojit';
                vpnToggleBtn.style.backgroundColor = 'var(--color-accent-blue)';
                document.getElementById('vpn-protocol-select').disabled = false;
                document.getElementById('vpn-server-select').disabled = false;
                setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium'); 
                return;
             }

            vpnToggleBtn.disabled = true;
            vpnToggleBtn.innerText = 'Probíhá připojování...';
            vpnToggleBtn.style.backgroundColor = 'var(--color-warning-yellow)';
            document.getElementById('vpn-protocol-select').disabled = true;
            document.getElementById('vpn-server-select').disabled = true;
            
            vpnStatusCard.innerHTML = `<div style="padding: 10px; background-color: var(--content-bg); border-radius: 8px;">
                                           <h3 id="vpn-status-header" style="color: var(--color-warning-yellow);"><i class="fas fa-hourglass-half"></i> Stav: Navazování šifrovaného spojení...</h3>
                                           <p id="vpn-ip-display">Probíhá handshake (Protokol: ${selectedProtocol})... </p>
                                           <div class="loading-bar"><div class="loading-fill"></div></div>
                                       </div>`;
            
            logActivity(`Pokus o připojení k VPN serveru: ${selectedServer} (${selectedProtocol}).`);
            
            // --- SIMULACE 5 MINUT ---
            setTimeout(() => {
                isVpnConnected = true;
                vpnToggleBtn.disabled = false;
                vpnToggleBtn.innerText = 'Odpojit';
                vpnToggleBtn.style.backgroundColor = 'var(--color-danger-red)';
                
                const newIp = calculateSimulatedIP(selectedServer);
                currentUser.vpnIp = newIp;
                saveCurrentUserState();
                
                vpnStatusCard.innerHTML = `<div style="padding: 10px; background-color: var(--content-bg); border-radius: 8px;">
                        <h3 id="vpn-status-header" style="color: var(--color-accent-green);"><i class="fas fa-check-circle"></i> Stav: Připojeno (${selectedServer})</h3>
                        <p id="vpn-ip-display">IP Adresa: ${newIp} (Protokol: ${selectedProtocol})</p>
                    </div>`;
                
                logActivity(`Úspěšně připojeno k VPN: ${selectedServer}.`, 'var(--color-accent-green)', true);
                setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium'); 
                
                if(vpnInterval) clearInterval(vpnInterval);
                vpnInterval = setInterval(() => {}, 5000); // Fiktivní interval pro aktivitu

            }, SIMULATION_DURATION_SHORT);
        };


        // --- IDENTITY GUARD (Simulace 10 minut) ---
        
        const generateIdentityGuardHtml = () => {
             const isPro = currentUser.isPaid;
             const items = SIMULATION_DATA.IDENTITY_ITEMS.map((item, index) => {
                 return `<div class="config-item">
                            <div class="item-info">
                                <strong>${item.name}</strong>
                                <span>Typ: ${item.type}</span>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="identity-${index}" ${item.defaultChecked ? 'checked' : ''} onchange="logActivity('Změněno monitorování pro: ${item.name}.')">
                                <span class="slider round"></span>
                            </label>
                        </div>`;
             }).join('');
             
             const isPaidContent = `<p style="margin-bottom: 20px;">Vyberte, které osobní údaje chcete monitorovat v Dark Webu.</p>
                     ${generateBreachWarning()}
                     <div class="config-group" id="identity-checkbox-list">
                        ${items}
                     </div>
                     <button id="start-identity-protection-btn" class="primary-btn" style="margin-top: 15px;"><i class="fas fa-search-dollar"></i> Spustit Kontrolu Narušení</button>
                     <div id="identity-status-area" style="margin-top: 15px;">
                         <p style="color: var(--text-muted);">Kontrola je spuštěna na pozadí. Klikněte pro **manuální spuštění**.</p>
                     </div>
                     `;
            return isPro ? isPaidContent : `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>`;
        };

        const handleIdentityProtection = (btn) => {
            btn.disabled = true;
            btn.innerText = 'Probíhá spouštění hloubkové analýzy Dark Webu...';
            logActivity(`Spuštěna manuální kontrola Identity Guard.`);
            const statusArea = document.getElementById('identity-status-area');
            
            // --- SIMULACE PRŮBĚHU ---
            const messages = [
                "Inicializace Dark Web API a šifrovaného tunelu...",
                "Vyhledávání primárního e-mailu v kompromitovaných databázích...",
                "Křížová kontrola uložených platebních údajů (tokenizace)...",
                "Analýza fiktivních datových sad A-92 / B-85...",
                "Zpracování 95% ověřených zdrojů... (Dokončování)"
            ];
            let msgIndex = 0;
            const messageInterval = SIMULATION_DURATION_LONG / messages.length; // Postupná změna textu
            
            const updateStatus = () => {
                 if (msgIndex < messages.length) {
                     statusArea.innerHTML = `<p style="color: var(--color-warning-yellow);">${messages[msgIndex]}</p><div class="loading-bar"><div class="loading-fill scan-fill"></div></div>`;
                     msgIndex++;
                 }
            };
            updateStatus();
            const intervalId = setInterval(updateStatus, messageInterval);
            
            // --- SIMULACE 10 MINUT ---
            setTimeout(() => {
                clearInterval(intervalId);
                btn.disabled = false;
                btn.innerText = 'Spustit Kontrolu Narušení';
                
                if (!currentUser.hasBreach && Math.random() < 0.4) { 
                    currentUser.hasBreach = true;
                    currentUser.threatsFound++;
                    saveCurrentUserState();
                    const breachMessage = `🚨 **NÁLEZ ÚNIKU DAT!** Váš Primární e-mail byl nalezen v databázi Dark Webu.`;
                    logActivity(breachMessage, 'var(--color-danger-red)', true);
                    alert(breachMessage + ' Přejděte do Identity Guard pro řešení.');
                    statusArea.innerHTML = generateBreachWarning();
                } else {
                     statusArea.innerHTML = `<p style="color: var(--color-accent-green); font-weight: bold; margin-top: 15px;"><i class="fas fa-check-circle"></i> Žádná nová narušení nenalezena. Vaše data jsou v bezpečí.</p>`;
                     logActivity(`Kontrola Identity Guard dokončena. Žádná nová narušení.`, 'var(--color-accent-green)');
                }
                setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium');
            }, SIMULATION_DURATION_LONG);
        };
        
        const generateBreachWarning = () => {
             if (currentUser.hasBreach) {
                 return `
                    <div class="dashboard-card" style="border: 2px solid var(--color-danger-red); margin-top: 20px;">
                        <h3 style="color: var(--color-danger-red);"><i class="fas fa-exclamation-triangle"></i> AKCE JE VYŽADOVÁNA!</h3>
                        <p>Byl nalezen únik dat pro **Primární e-mail**.</p>
                        <button class="primary-btn" style="background-color: var(--color-danger-red);" onclick="handleSecureIdentity()">Zabezpečit Nyní (Změnit Heslo)</button>
                    </div>
                 `;
             }
             return '';
        };
        
        const handleSecureIdentity = () => {
             currentUser.hasBreach = false;
             currentUser.threatsFound = Math.max(0, currentUser.threatsFound - 1); 
             saveCurrentUserState();
             logActivity(`Identita **Primární e-mail** byla úspěšně zabezpečena.`, 'var(--color-accent-green)', true);
             document.getElementById('identity-content').innerHTML = generateIdentityGuardHtml(); // Překreslení
             setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium');
        };


        // --- CHYTRÝ SKEN (Simulace 10 minut bez odpočtu) ---
        
        const generateSimulatedThreats = () => {
             let threats = [];
             
             for(let i = 0; i < currentUser.threatsFound; i++) {
                 const randomThreat = SIMULATION_DATA.SIMULATED_THREATS[i % SIMULATION_DATA.SIMULATED_THREATS.length];
                 if (!threats.some(t => t.name === randomThreat.name)) {
                      threats.push({ ...randomThreat, ignored: false, type: 'CRITICAL'});
                 }
             }

             if (Math.random() < 0.2) {
                 threats.push({ name: "SystemCore_54B.dll", type: "PUP (Potenciálně Nežádoucí)", location: "System32", ignored: false });
             }
             
             if (SIMULATION_DATA.SYSTEM_INFO.PATCH_DATE < new Date(new Date().setDate(new Date().getDate() - 30))) { 
                 threats.push({ name: "Zastaralý Kernel Patch", type: "Vulnerability", location: "OS Core", ignored: false });
             }

             return threats;
        };

        const generateScanThreatsTable = () => {
             if (simulatedThreats.length === 0) return '';
             
             const headerHtml = `
                 <div class="item-row" style="font-weight: bold; padding-bottom: 5px; border-bottom: 2px solid var(--hr-color);">
                     <span style="flex: 2;">Nález</span><span style="flex: 1;">Typ</span><span style="flex: 1; text-align: right;">Akce</span>
                 </div>
             `;
             
             const rowsHtml = simulatedThreats.map((threat, index) => `
                 <div class="item-row" style="color: ${threat.ignored ? 'var(--color-warning-yellow)' : 'var(--color-danger-red)'}; opacity: ${threat.ignored ? 0.7 : 1};">
                     <span style="flex: 2;">${threat.name}</span>
                     <span style="flex: 1; font-size: 0.8em;">${threat.type}</span>
                     <span style="flex: 1; text-align: right;">
                         ${threat.ignored 
                             ? '<i class="fas fa-eye-slash" style="color: var(--color-warning-yellow);"> Ignorováno</i>'
                             : `<button style="background: none; border: none; color: var(--color-danger-red); cursor: pointer; font-size: 0.9em;" onclick="handleScanThreatAction(${index}, 'delete')">Odstranit</button>`
                         }
                     </span>
                 </div>
             `).join('');
             
             return `
                 <div id="scan-threat-report" class="config-group" style="border: 2px solid var(--color-danger-red); margin-top: 20px;">
                     <h3><i class="fas fa-bug"></i> Detailní Report Hrozeb</h3>
                     ${headerHtml}
                     ${rowsHtml}
                     <button class="secondary-btn" style="margin-top: 15px;" onclick="logActivity('Simulace exportu zprávy do PDF...', 'var(--color-accent-blue)', true);">Simulovat Export Reportu (PDF)</button>
                 </div>
             `;
        };
        
        const handleScanThreatAction = (index, action) => {
             if (simulatedThreats[index].ignored) return; 
             
             if (action === 'delete') {
                  const threatName = simulatedThreats[index].name;
                  
                  if (threatName.includes('SystemCore_54B.dll')) {
                       logActivity(`CHYBA SYSTÉMU: Pokus o smazání ${threatName} způsobil narušení systému. Vyžadována oprava.`, 'var(--color-danger-red)', true);
                       currentUser.threatsFound = Math.max(currentUser.threatsFound + 2, 5); 
                       alert('Kritická chyba: Smazání systémového souboru narušilo stabilní provoz. Okamžitě spusťte Opravu!');
                       simulatedThreats.splice(index, 1);
                  } else {
                       simulatedThreats.splice(index, 1);
                       logActivity(`Hrozba ${threatName} odstraněna.`);
                       currentUser.threatsFound = Math.max(0, currentUser.threatsFound - 1);
                  }
                  
                  saveCurrentUserState();
                  document.getElementById('scan-content').innerHTML = generateScanHtml();
                  setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium');
                  
             } 
        };

        const startScanSimulation = (isRepair = false) => {
             const scanStatus = document.getElementById('scan-status');
             const scanVisuals = document.getElementById('scan-visuals');
             
             if (!scanStatus || !scanVisuals) return;
             
             const scanBtnSecondary = document.getElementById('start-scan-secondary');
             const repairBtn = document.getElementById('repair-all-btn');
             if (scanBtnSecondary) scanBtnSecondary.disabled = true;
             if (repairBtn) repairBtn.disabled = true;

             if (isRepair) logActivity(`Spuštěna simulace **OPRAVY** systému.`);
             else logActivity(`Spuštěn Chytrý Sken.`);
             
             const duration = isRepair ? SIMULATION_DURATION_SHORT : SIMULATION_DURATION_LONG;
             const messages = SIMULATION_DATA.SCAN_LOADING_MESSAGES;
             let msgIndex = 0;
             const messageInterval = duration / messages.length; 
             
             // --- Inicializace vizuálu loadingu ---
             scanVisuals.innerHTML = `
                 <p style="font-weight: bold;">Stav: <span id="scan-running-status" style="color: var(--color-warning-yellow);">Inicializace...</span></p>
                 <div class="loading-bar"><div class="loading-fill scan-fill"></div></div>
                 <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 10px;">Probíhá hloubková analýza jádra (Simulace bez viditelného odpočtu)</p>
             `;
             const runningStatus = document.getElementById('scan-running-status');

             // Funkce pro aktualizaci textu
             const updateRunningStatus = () => {
                 if (msgIndex < messages.length) {
                     runningStatus.innerText = messages[msgIndex];
                     msgIndex++;
                 }
             };

             updateRunningStatus(); 
             const intervalId = setInterval(updateRunningStatus, messageInterval);
             
             // --- Konec simulace ---
             setTimeout(() => {
                 clearInterval(intervalId);
                 
                 // Znovu povolit tlačítka a vypsat výsledek
                 if (scanBtnSecondary) scanBtnSecondary.disabled = false;
                 if (repairBtn) repairBtn.disabled = false;
                 
                 if (isRepair) {
                     simulatedThreats = [];
                     currentUser.threatsFound = 0;
                     scanStatus.innerText = _('repair_done');
                     scanStatus.style.color = 'var(--color-accent-green)';
                     logActivity(_('repair_done'), 'var(--color-accent-green)', true);
                 } else {
                     simulatedThreats = generateSimulatedThreats();
                     currentUser.threatsFound = simulatedThreats.length;
                     scanStatus.innerText = _('scan_done').replace('%s', currentUser.threatsFound);
                     scanStatus.style.color = currentUser.threatsFound > 0 ? 'var(--color-danger-red)' : 'var(--color-accent-green)';
                     if (currentUser.threatsFound > 0) addNotification(`Nalezeno ${currentUser.threatsFound} kritických hrozeb!`);
                 }
                 
                 saveCurrentUserState();
                 document.getElementById('scan-content').innerHTML = generateScanHtml();
                 setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium');
                 
             }, duration);
        };
        
        const handleScanToggleChange = (e, item) => {
             logActivity(`Změněno nastavení skenování: ${item.name} je nyní ${e.target.checked ? 'Aktivní' : 'Neaktivní'}.`);
        };
        
        const handleScheduleChange = (select) => {
             currentUser.scan_schedule = select.value;
             logActivity(`Plán automatického skenu nastaven na: ${select.value}.`, 'var(--color-accent-blue)');
             saveCurrentUserState();
        };

        const generateScanHtml = () => {
             const isPro = currentUser.isPaid;
             const threatsCount = currentUser.threatsFound;
             
             const scanAreasHtml = SIMULATION_DATA.SCAN_AREAS.map((item, index) => {
                 const control = `<label class="toggle-switch"><input type="checkbox" id="scan-area-${index}" ${item.default ? 'checked' : ''} onchange="handleScanToggleChange(event, '${item.name}')"><span class="slider round"></span></label>`;
                 return `<div class="config-item"><div class="item-info"><strong>${item.name}</strong></div>${control}</div>`;
             }).join('');
             
             const scheduleOptions = SIMULATION_DATA.SCAN_SCHEDULES.map(schedule => 
                `<option value="${schedule}" ${currentUser.scan_schedule === schedule ? 'selected' : ''}>${schedule}</option>`
             ).join('');
             
             const scanStatus = isPro ? `
                 <div id="scan-visuals">
                     <p>Aktuální stav: <span id="scan-status">${_('scan_status_ready')}</span></p>
                 </div>
                 <div id="scan-results" class="dashboard-card" style="margin-top: 30px;">
                     <h3>Sumář výsledků</h3>
                     <p>${_('threats_found')} <span id="threats-count" style="font-weight: bold; color: ${threatsCount > 0 ? 'var(--color-danger-red)' : 'var(--color-accent-green)'};">${threatsCount}</span></p>
                     ${threatsCount > 0 ? 
                         `<button id="repair-all-btn" class="primary-btn" style="background-color: var(--color-danger-red);" onclick="startScanSimulation(true)"><i class="fas fa-wrench"></i> ${_('scan_repair')}</button>` 
                         : ''}
                     <button id="start-scan-secondary" class="primary-btn" style="background-color: var(--color-accent-blue);">${_('scan_run')}</button>
                 </div>
                 ${generateScanThreatsTable()} 
                 
                 <h3 style="margin-top: 20px;"><i class="fas fa-calendar-alt"></i> Plánování Skenu</h3>
                 <div class="config-group">
                      <p>Aktuálně nastaveno: <strong>${currentUser.scan_schedule}</strong></p>
                      <select onchange="handleScheduleChange(this)">
                          ${scheduleOptions}
                      </select>
                      <button class="secondary-btn" style="margin-top: 10px;" onclick="logActivity('Simulace přidání souboru do výjimek.')">Přidat/Odebrat Výjimku</button>
                 </div>

                 <h3 style="margin-top: 20px;">Typy Skenování (Nyní funkční)</h3>
                 <div class="config-group">
                     ${scanAreasHtml}
                 </div>
             ` : `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>`;
             
             return scanStatus;
        };


        // --- MODULY DLE IDEÍ ---
        
        // MODUL OPTIMALIZACE (Simulace 5 minut)
        const generateOptimizationHtml = () => {
             const freedSpace = Math.floor(Math.random() * 800) + 200; 
             const processes = Math.floor(Math.random() * 10) + 5; 
             
             return `
                <div class="dashboard-card">
                    <h3><i class="fas fa-broom"></i> Akcelerace a Čištění</h3>
                    <p>Potenciálně zbytečné soubory cache: **${freedSpace} MB**</p>
                    <p>Procesy na pozadí zpomalující systém: **${processes}**</p>
                    <p style="color: var(--color-warning-yellow); margin-top: 10px;">Doporučeno spuštění pro optimalizaci výkonu.</p>
                    <div id="optimization-status">
                       <button class="primary-btn" id="start-optimize-btn" onclick="handleOptimization(this, ${freedSpace}, ${processes})"><i class="fas fa-angle-double-up"></i> Optimalizovat Zařízení</button>
                    </div>
                </div>
                <h3 style="margin-top: 20px;">Detaily Systémových Procesů</h3>
                <div class="config-group">
                     <p>Simulované **RAM** uvolnění: **30%**</p>
                     <p>Optimalizovaný **Start-up** čas: **1.2s**</p>
                </div>
             `;
        };
        
        const handleOptimization = (btn, space, proc) => {
             btn.disabled = true;
             logActivity(`Spuštěna optimalizace výkonu.`);
             
             const statusDiv = document.getElementById('optimization-status');
             statusDiv.innerHTML = `
                 <p style="font-weight: bold; color: var(--color-warning-yellow);">Provádím hloubkovou analýzu RAM a CPU cyklů...</p>
                 <div class="loading-bar"><div class="loading-fill"></div></div>
             `;
             
             // --- SIMULACE 5 MINUT ---
             setTimeout(() => {
                 statusDiv.innerHTML = `<p style="color: var(--color-accent-green); font-weight: bold;">Dokončeno! Uvolněno ${space} MB a zrychleno ${proc} procesů.</p>`;
                 
                 const newBtn = document.createElement('button');
                 newBtn.className = 'primary-btn';
                 newBtn.innerText = 'Opakovat Optimalizaci';
                 newBtn.onclick = () => { document.getElementById('optimization-content').innerHTML = generateOptimizationHtml(); };
                 statusDiv.appendChild(newBtn);
                 
                 logActivity(`Optimalizace dokončena. Uvolněno ${space} MB.`, 'var(--color-accent-green)', true);
                 setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium'); 
                 
             }, SIMULATION_DURATION_SHORT);
        };
        
        // MODUL WEB SHIELD (Simulace 5 minut)
        const generateWebShieldHtml = () => {
             return `
                <div class="dashboard-card">
                    <h3><i class="fas fa-link"></i> Web Shield Status</h3>
                    <p style="color: var(--color-accent-green);">Štít je aktivní a chrání vás proti phishingovým a malwarovým stránkám.</p>
                    <div id="web-scan-status">
                       <button class="primary-btn" id="start-web-scan" onclick="handleWebScan(this)"><i class="fas fa-shield-alt"></i> Spustit Rychlou Kontrolu Štítu</button>
                    </div>
                </div>
                <h3 style="margin-top: 20px;">Nastavení Štítu (Více možností)</h3>
                <div class="config-group">
                     <div class="config-item">
                         <div class="item-info"><strong>Blokování Malwarových Stránek</strong><span>Aktivní ochrana proti známým hrozbám.</span></div>
                         <label class="toggle-switch"><input type="checkbox" checked><span class="slider round"></span></label>
                     </div>
                     <div class="config-item">
                         <div class="item-info"><strong>Kontrola HTTPS certifikátů</strong><span>Ověřuje platnost certifikátu webu.</span></div>
                         <label class="toggle-switch"><input type="checkbox" checked><span class="slider round"></span></label>
                     </div>
                     <div class="config-item">
                         <div class="item-info"><strong>Anti-Tracker Technologie</strong><span>Blokuje sledovací skripty třetích stran.</span></div>
                         <label class="toggle-switch"><input type="checkbox"><span class="slider round"></span></label>
                     </div>
                      <div class="config-item">
                         <div class="item-info"><strong>Vynucení SafeSearch</strong><span>Zajišťuje bezpečné výsledky vyhledávání.</span></div>
                         <label class="toggle-switch"><input type="checkbox" checked><span class="slider round"></span></label>
                     </div>
                </div>
             `;
        };
        
        const handleWebScan = (btn) => {
             btn.disabled = true;
             logActivity(`Spuštěna kontrola Web Shieldu.`);
             
             const statusDiv = document.getElementById('web-scan-status');
             statusDiv.innerHTML = `
                 <p style="font-weight: bold; color: var(--color-warning-yellow);">Ověřování integrity všech ochranných vrstev a DNS zabezpečení...</p>
                 <div class="loading-bar"><div class="loading-fill"></div></div>
             `;
             
             // --- SIMULACE 5 MINUT ---
             setTimeout(() => {
                 
                 statusDiv.innerHTML = `<button class="primary-btn" id="start-web-scan" onclick="handleWebScan(this)" style="background-color: var(--color-accent-green);"><i class="fas fa-check-circle"></i> Všechny vrstvy Štítu aktivní</button>`;
                 logActivity(`Web Shield kontrola dokončena. Vše v pořádku.`, 'var(--color-accent-green)', true);
             }, SIMULATION_DURATION_SHORT);
        };


        // MODUL TREZOR (Simulace 5 minut)
        const generateVaultHtml = () => {
             return `
                <div class="dashboard-card">
                    <h3><i class="fas fa-key"></i> ${_('vault_title')}</h3>
                    <p style="color: var(--text-muted);">${_('vault_desc')}</p>
                    
                    <h4 style="margin-top: 20px;">Uložené položky</h4>
                    <div class="config-group" style="padding: 10px;">
                        <div class="item-row"><span>Heslo pro E-mail</span><span style="color: var(--color-accent-green);">Aktivní</span></div>
                        <div class="item-row"><span>Číslo Pasu (Sken)</span><span style="color: var(--color-accent-green);">Aktivní</span></div>
                        <div class="item-row"><span>Heslo pro Sociální Síť</span><span style="color: var(--color-accent-green);">Aktivní</span></div>
                    </div>
                    <div id="vault-unlock-status">
                        <input type="password" id="vault-master-password" placeholder="Zadejte Master Heslo pro odemčení">
                        <button class="primary-btn" id="vault-unlock-btn" onclick="handleVaultUnlock(this)"><i class="fas fa-unlock"></i> Odemknout Trezor</button>
                    </div>
                    
                    <button class="secondary-btn" onclick="logActivity('Simulace přidání nové položky do Trezoru.')" style="margin-top: 10px;">Přidat Novou Položku</button>
                </div>
             `;
        };
        
        const handleVaultUnlock = (btn) => {
             btn.disabled = true;
             logActivity(`Pokus o odemčení trezoru.`);
             
             const statusDiv = document.getElementById('vault-unlock-status');
             statusDiv.innerHTML = `
                 <p style="font-weight: bold; color: var(--color-warning-yellow);">Probíhá dešifrování dat...</p>
                 <div class="loading-bar"><div class="loading-fill"></div></div>
             `;
             
             // --- SIMULACE 5 MINUT ---
             setTimeout(() => {
                 
                 if (Math.random() > 0.3) {
                      logActivity(`Trezor úspěšně odemčen.`, 'var(--color-accent-green)');
                      statusDiv.innerHTML = `<button class="primary-btn" style="background-color: var(--color-accent-green);"><i class="fas fa-lock-open"></i> Trezor Odemčen</button>`;
                      alert('Trezor úspěšně odemčen!');
                 } else {
                      logActivity(`Chyba ověření Master Hesla.`, 'var(--color-danger-red)');
                      statusDiv.innerHTML = `<button class="primary-btn" id="vault-unlock-btn" onclick="handleVaultUnlock(this)"><i class="fas fa-unlock"></i> Odemknout Trezor</button>`;
                      alert('Chyba: Master Heslo je neplatné.');
                 }
             }, SIMULATION_DURATION_SHORT);
        };
        
        // MODUL ZÁLOHOVÁNÍ (Simulace 10 minut)
        const generateBackupHtml = () => {
             return `
                <div class="dashboard-card">
                    <h3><i class="fas fa-cloud-upload-alt"></i> Cloudová Záloha</h3>
                    <p>Stav: **Poslední záloha proběhla 20. 11. 2025**</p>
                    <p>Velikost: **1.8 GB**</p>
                    <div id="backup-status">
                       <button class="primary-btn" id="start-backup-btn" onclick="handleBackup(this)"><i class="fas fa-cloud-upload-alt"></i> Spustit Novou Zálohu</button>
                    </div>
                    
                    <h4 style="margin-top: 20px;">Historie Záloh</h4>
                    <div class="config-group" style="padding: 10px;">
                        <div class="item-row"><span>20. 11. 2025 (1.8 GB)</span><button style="background: none; border: none; color: var(--color-accent-blue); cursor: pointer;" onclick="logActivity('Spuštěna simulace obnovy dat.')">Obnovit</button></div>
                        <div class="item-row"><span>05. 11. 2025 (1.7 GB)</span><button style="background: none; border: none; color: var(--color-accent-blue); cursor: pointer;">Obnovit</button></div>
                    </div>
                </div>
             `;
        };
        
        const handleBackup = (btn) => {
             btn.disabled = true;
             logActivity(`Spuštěno Cloudové Zálohování.`);
             
             const statusDiv = document.getElementById('backup-status');
             statusDiv.innerHTML = `
                 <p style="font-weight: bold; color: var(--color-warning-yellow);">Připojení k šifrovanému cloudovému úložišti a nahrávání dat...</p>
                 <div class="loading-bar"><div class="loading-fill scan-fill"></div></div>
             `;
             
             // --- SIMULACE 10 MINUT ---
             setTimeout(() => {
                 statusDiv.innerHTML = `<button class="primary-btn" style="background-color: var(--color-accent-green);"><i class="fas fa-check-circle"></i> Zálohování Dokončeno!</button>`;
                 logActivity(`Zálohování dokončeno.`, 'var(--color-accent-green)', true);
             }, SIMULATION_DURATION_LONG);
        };

        // MODUL OCHRANA SOUKROMÍ 
        const generatePrivacyHtml = () => {
            const appHtml = SIMULATION_DATA.APP_PERMISSIONS.map((app, index) => {
                 const currentPermission = app.permissions.join(', ');
                 const isHighRisk = app.type === 'Malware';
                 const isRestricted = app.restricted;
                 
                 const status = isHighRisk ? 
                    `<span style="color: var(--color-danger-red); font-weight: bold;"><i class="fas fa-exclamation-triangle"></i> VYSOKÉ RIZIKO</span>` : 
                    `<span style="color: var(--color-warning-yellow);">Normální Riziko</span>`;

                 return `
                    <div class="config-item" style="flex-direction: column; align-items: flex-start;">
                        <div style="width: 100%; display: flex; justify-content: space-between; align-items: center; color: var(--text-color);">
                            <strong>${_('app_perm_title')}: ${app.name}</strong>
                            ${status}
                        </div>
                        <span style="font-size: 0.8em; color: var(--text-muted);">Oprávnění: ${currentPermission}</span>
                        <button class="secondary-btn" style="width: auto; margin-top: 5px; background-color: ${isRestricted ? 'var(--color-accent-green)' : 'var(--input-border)'};" 
                            onclick="handlePermissionToggle(this, '${app.name}', ${index})">
                            ${isRestricted ? _('app_perm_toggle_on') : _('app_perm_toggle')}
                        </button>
                    </div>
                 `;
             }).join('');
             
             return `
                <div class="dashboard-card">
                    <h3><i class="fas fa-lock"></i> ${_('app_perm_scan')}</h3>
                    <p style="color: var(--text-muted);">${_('app_perm_info')}</p>
                </div>
                
                <h3 style="margin-top: 20px;">Detaily Oprávnění</h3>
                <div class="config-group">
                    ${appHtml}
                </div>
                <h3 style="margin-top: 20px;">Wi-Fi Security Scan (PRO)</h3>
                <div class="config-group" id="wifi-scan-area">
                     <p>Status: **Síť je chráněna (WPA3)**</p>
                     <button class="secondary-btn" id="start-wifi-scan-btn" onclick="handleWifiScan(this)">Spustit síťový test</button>
                </div>
             `;
        };
        
        const handlePermissionToggle = (btn, appName, index) => {
             const newRestrictedState = !SIMULATION_DATA.APP_PERMISSIONS[index].restricted;
             SIMULATION_DATA.APP_PERMISSIONS[index].restricted = newRestrictedState;
             
             if (newRestrictedState) {
                 btn.innerText = _('app_perm_toggle_on');
                 btn.style.backgroundColor = 'var(--color-accent-green)';
                 logActivity(`Omezen přístup pro aplikaci: ${appName}.`, 'var(--color-accent-green)');
             } else {
                 btn.innerText = _('app_perm_toggle');
                 btn.style.backgroundColor = 'var(--input-border)';
                 logActivity(`Obnoven přístup pro aplikaci: ${appName}.`);
             }
        };

        const handleWifiScan = (btn) => {
             btn.disabled = true;
             logActivity(`Spuštěna Wi-Fi analýza.`);
             
             const statusDiv = document.getElementById('wifi-scan-area');
             statusDiv.innerHTML = `
                 <p style="font-weight: bold; color: var(--color-warning-yellow);">Provádím hloubkovou analýzu sítě a ověřování DNS...</p>
                 <div class="loading-bar"><div class="loading-fill"></div></div>
             `;
             
             // --- SIMULACE 5 MINUT ---
             setTimeout(() => {
                 
                 if (Math.random() > 0.2) {
                      logActivity(`Wi-Fi sken dokončen. Nalezena jedna menší zranitelnost.`, 'var(--color-warning-yellow)', true);
                      statusDiv.innerHTML = `<p style="font-weight: bold; color: var(--color-warning-yellow);">Status: Nalezena menší zranitelnost!</p><button class="secondary-btn" id="start-wifi-scan-btn" onclick="handleWifiScan(this)">Opakovat test</button>`;
                      alert('Wi-Fi sken dokončen. Nalezena jedna menší zranitelnost (doporučeno resetování routeru).');
                 } else {
                      logActivity(`Wi-Fi síť je zabezpečená.`, 'var(--color-accent-green)');
                      statusDiv.innerHTML = `<p style="font-weight: bold; color: var(--color-accent-green);">Status: Síť je zabezpečená (WPA3)</p><button class="secondary-btn" id="start-wifi-scan-btn" onclick="handleWifiScan(this)">Opakovat test</button>`;
                      alert('Wi-Fi síť je zabezpečená.');
                 }
             }, SIMULATION_DURATION_SHORT);
        };
        
        // --- PROFIL A HISTORIE (Vylepšené) ---
        
        const handleLanguageSwitch = (select) => {
             currentLang = select.value;
             logActivity(`Jazyk přepnut na: ${select.options[select.selectedIndex].text}.`, 'var(--color-accent-blue)');
             unlockFeaturesUI(currentUser.isPaid ? 'PRO' : 'Freemium', null, 'settings'); 
        };

        const handleThemeSwitch = () => {
             const appWindow = document.getElementById('app-window');
             const themeToggleIcon = document.querySelector('#theme-toggle-btn i');
             
             if (appWindow.classList.contains('dark-mode')) {
                 appWindow.classList.remove('dark-mode');
                 appWindow.classList.add('light-mode');
                 currentUser.currentTheme = 'light';
                 themeToggleIcon.className = 'fas fa-sun';
                 logActivity("Téma přepnuto na: Světlý režim.", 'var(--text-color)');
             } else {
                 appWindow.classList.remove('light-mode');
                 appWindow.classList.add('dark-mode');
                 currentUser.currentTheme = 'dark';
                 themeToggleIcon.className = 'fas fa-moon';
                 logActivity("Téma přepnuto na: Tmavý režim.", 'var(--text-color)');
             }
             saveCurrentUserState();
             // Zajištění aktualizace textů v novém módu
             makeFunctional(currentUser.isPaid);
             setDashboardContent(currentUser.isPaid ? 'PRO' : 'Freemium');
             if(document.getElementById('settings').classList.contains('hidden') === false) {
                 document.getElementById('settings-content').innerHTML = generateSettingsHtml();
             }
        };

        const generateSettingsHtml = () => {
            const logs = JSON.parse(localStorage.getItem(ACTIVITY_LOG_KEY)) || [];
            
            const logHtml = logs.length > 0
                ? logs.map(log => `<div class="activity-log-item" style="color: ${log.color};"><strong>${log.timestamp}</strong>: ${log.description}</div>`).join('')
                : `<div class="activity-log-item" style="color: var(--text-muted);">Žádná zaznamenaná aktivita.</div>`;
                
            const expirationInfo = currentUser.isPaid 
                ? `<p>PRO Licence platná do: <strong style="color: var(--color-accent-green);">${currentUser.license_expiration_date || 'Neznámé datum'}</strong></p>` 
                : `<p>Licence: <strong style="color: var(--color-danger-red);">Freemium</strong>. <a href="#" onclick="switchModule('paysafe')">Přejít na PRO.</a></p>`;

            return `
                <h3 style="margin-top: 0;"><i class="fas fa-user"></i> Správa Profilu</h3>
                <div class="config-group">
                    <p>Uživatelské jméno: <strong>${currentUser.username}</strong></p>
                    ${expirationInfo}
                    ${currentUser.isPaid ? `<p>Licenční klíč: <strong style="color: var(--color-warning-yellow);">${currentUser.license_key || 'N/A'}</strong></p>` : ''}
                    <p>Heslo: <span style="color: var(--color-warning-yellow);">** Skryto pro bezpečnost **</span></p>
                    <button class="secondary-btn" style="margin-top: 10px;" onclick="logActivity('Změna hesla simulována.')"><i class="fas fa-lock"></i> Změnit Heslo</button>
                </div>
                
                <h3 style="margin-top: 20px;"><i class="fas fa-info-circle"></i> Technické Informace</h3>
                <div class="config-group">
                    <p>Kernel Verze: <strong>${SIMULATION_DATA.SYSTEM_INFO.KERNEL_VERSION}</strong></p>
                    <p>Poslední Patch: <strong style="color: ${SIMULATION_DATA.SYSTEM_INFO.PATCH_DATE < new Date(new Date().setDate(new Date().getDate() - 30)) ? 'var(--color-danger-red)' : 'var(--color-accent-green)'};">${SIMULATION_DATA.SYSTEM_INFO.PATCH_DATE.toLocaleDateString('cs-CZ')}</strong></p>
                    <p>Kód Karantény: <strong>${SIMULATION_DATA.SYSTEM_INFO.QUARANTINE_CODE}</strong></p>
                </div>
                
                <h3 style="margin-top: 20px;"><i class="fas fa-palette"></i> Vzhled a Jazyk</h3>
                <div class="config-group">
                     <p>Aktuální Téma: <strong>${currentUser.currentTheme === 'dark' ? 'Tmavé' : 'Světlé'}</strong></p>
                     <p>Přepnout Jazyk:</p>
                     <select onchange="handleLanguageSwitch(this)">
                        <option value="cs" ${currentLang === 'cs' ? 'selected' : ''}>Čeština</option>
                        <option value="en" ${currentLang === 'en' ? 'selected' : ''}>English</option>
                     </select>
                </div>

                <h3 style="margin-top: 20px;"><i class="fas fa-history"></i> Historie Aktivity</h3>
                <div class="config-group" style="max-height: 200px; overflow-y: auto;">
                    ${logHtml}
                </div>
                <button class="secondary-btn" onclick="clearActivityLog()"><i class="fas fa-eraser"></i> Vyčistit log aktivity</button>
            `;
        };

        const clearActivityLog = () => {
            if (confirm("Opravdu chcete vyčistit celý log aktivity? Tato akce je nevratná.")) {
                localStorage.removeItem(ACTIVITY_LOG_KEY);
                logActivity("Log aktivity vyčištěn uživatelem.");
                document.getElementById('settings-content').innerHTML = generateSettingsHtml();
            }
        };
        
        // --- HLAVNÍ FUNKCE PRO AKTIVACI ---
        
        const makeFunctional = (isPro) => {
            
            const modulesConfig = {
                'scan': { proHtml: generateScanHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'vpn': { proHtml: generateVpnHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'identity': { proHtml: generateIdentityGuardHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'optimization': { proHtml: generateOptimizationHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'web_shield': { proHtml: generateWebShieldHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'vault': { proHtml: generateVaultHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'backup': { proHtml: generateBackupHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'privacy': { proHtml: generatePrivacyHtml(), freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'payment_shield': { proHtml: document.getElementById('payment-shield-content').innerHTML, freemiumHtml: `<p style="color: var(--color-danger-red);">${_('lock_title')} ${_('lock_msg')}</p><button class="secondary-btn" onclick="switchModule('paysafe')">${_('buy_pro')}</button>` },
                'settings': { proHtml: generateSettingsHtml(), freemiumHtml: generateSettingsHtml() } 
            };

            for (const moduleId in modulesConfig) {
                const moduleContentDiv = document.getElementById(`${moduleId}-content`);
                if (moduleContentDiv) {
                    // Speciální pravidlo pro payment_shield, který nemá -content, ale je vložen přímo
                    if (moduleId === 'payment_shield') {
                         const parent = document.getElementById(moduleId);
                         if (parent) {
                              parent.innerHTML = isPro ? modulesConfig[moduleId].proHtml : modulesConfig[moduleId].freemiumHtml;
                         }
                    } else {
                         moduleContentDiv.innerHTML = isPro ? modulesConfig[moduleId].proHtml : modulesConfig[moduleId].freemiumHtml;
                    }
                }
            }

            // Připojení handlerů pro PRO funkce
            if (isPro) {
                const scanBtnSecondary = document.getElementById('start-scan-secondary');
                if (scanBtnSecondary) scanBtnSecondary.addEventListener('click', () => startScanSimulation(false));
                
                const identityProtectionBtn = document.getElementById('start-identity-protection-btn');
                if (identityProtectionBtn) identityProtectionBtn.addEventListener('click', () => handleIdentityProtection(identityProtectionBtn));

                const vpnToggle = document.getElementById('vpn-toggle');
                if (vpnToggle) vpnToggle.addEventListener('click', () => simulateVpnConnection(vpnToggle));
            }
        };

        const unlockFeaturesUI = (licenseType, message, targetModuleId) => {
            const isPro = licenseType === 'PRO';
            
            // Nastavení Téma
            const appWindow = document.getElementById('app-window');
            appWindow.className = currentUser.currentTheme + '-mode';
            document.querySelector('#theme-toggle-btn i').className = currentUser.currentTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';

            // 1. Nastavení Hlavičky
            document.getElementById('header-username').innerText = currentUser.username;
            document.getElementById('header-license-status').innerText = isPro ? _('paid_active') : _('freemium_active');
            document.getElementById('header-license-status').className = isPro ? 'status-active' : 'status-inactive';

            // 2. Nastavení Navigace (zámky)
            document.querySelectorAll('.nav-item').forEach(nav => {
                const navModule = nav.getAttribute('data-module');
                
                if (navModule === 'dashboard' || navModule === 'settings') { 
                    nav.classList.remove('locked'); 
                    const icons = { 'dashboard': 'fas fa-home', 'settings': 'fas fa-cogs' };
                    nav.querySelector('i').className = icons[navModule];
                    return; 
                }
                
                if (isPro) { 
                    nav.classList.remove('locked');
                    const icons = { 
                        'scan': 'fas fa-rocket', 'vpn': 'fas fa-globe', 
                        'identity': 'fas fa-user-shield', 'optimization': 'fas fa-tachometer-alt', 
                        'web_shield': 'fas fa-shield-alt', 'vault': 'fas fa-lock',
                        'payment_shield': 'fas fa-money-check-alt', 'privacy': 'fas fa-user-secret', 
                        'backup': 'fas fa-cloud-upload-alt'
                    };
                    nav.querySelector('i').className = icons[navModule] || 'fas fa-check';
                } else {
                    nav.classList.add('locked');
                    nav.querySelector('i').className = 'fas fa-lock';
                }
            });
            
            // 3. Nastavení Modulů
            setPaysafeModuleContent(); 
            setDashboardContent(licenseType);
            makeFunctional(isPro); 
            updateNotificationUI();

            if (message) alert(message);
            switchModule(targetModuleId);
        };
        
        // --- INICIALIZACE ---
        
        document.addEventListener('DOMContentLoaded', () => {
            
            // Původní handlery
            document.getElementById('show-login-btn').addEventListener('click', () => switchModule('login'));
            document.getElementById('show-register-btn').addEventListener('click', () => switchModule('register'));
            document.getElementById('register-btn').addEventListener('click', handleRegister);
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            
            // Původní navigační handlery
            document.querySelectorAll('#bottom-nav .nav-item').forEach(nav => {
                nav.addEventListener('click', (e) => {
                    e.preventDefault();
                    const moduleId = e.currentTarget.getAttribute('data-module');
                    if (e.currentTarget.classList.contains('locked') && (!currentUser || !currentUser.isPaid) && moduleId !== 'settings') { 
                        alert(`${_('lock_title')} ${_('lock_msg')}`);
                    } else {
                        switchModule(moduleId);
                    }
                });
            });

            // Hlavní spuštění aplikace
            loadCurrentUserState();

            if (currentUser) {
                const licenseType = currentUser.isPaid ? 'PRO' : 'Freemium';
                unlockFeaturesUI(licenseType, null, 'dashboard');
            } else {
                switchModule('auth_select');
            }
        });
    </script>
</body>
</html>
